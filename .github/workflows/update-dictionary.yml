name: Update Dictionary on New Lessons

on:
  push:
    branches: [ main ]
    paths:
      - 'src/content/blog/dia-*.md'
      - 'src/content/blog/d√≠a-*.md'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/content/blog/dia-*.md'
      - 'src/content/blog/d√≠a-*.md'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual dictionary update'
        required: false
        default: 'Manual update'

jobs:
  update-dictionary:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check for lesson changes
      id: check_changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E 'src/content/blog/d[i√≠]a-.*\.md'; then
          echo "lessons_changed=true" >> $GITHUB_OUTPUT
          echo "üìù New lesson files detected!"
        else
          echo "lessons_changed=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è No lesson files changed"
        fi
        
    - name: Update dictionary
      if: steps.check_changes.outputs.lessons_changed == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        echo "üîÑ Updating dictionary with new lessons..."
        npm run update-content
        
    - name: Check if dictionary files changed
      id: check_dict_changes
      if: steps.check_changes.outputs.lessons_changed == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        if git diff --name-only | grep -E 'src/data/'; then
          echo "dict_changed=true" >> $GITHUB_OUTPUT
          echo "üìä Dictionary files updated!"
          git status
        else
          echo "dict_changed=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è No dictionary changes to commit"
        fi
        
    - name: Commit and push dictionary updates
      if: steps.check_dict_changes.outputs.dict_changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all dictionary files
        git add src/data/
        
        # Create commit with detailed info
        NEW_LESSONS=$(git log --name-only --pretty="" HEAD~1..HEAD | grep -E 'src/content/blog/d[i√≠]a-.*\.md' | wc -l)
        COMMIT_MSG="ü§ñ Auto-update: Dictionary rebuilt with new lessons

        üìà Changes:
        - Processed $NEW_LESSONS new lesson(s)
        - Updated vocabulary chunks and indices
        - Regenerated language mappings
        
        üîß Generated with automated dictionary pipeline
        üïê $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        Co-Authored-By: Dictionary Bot <noreply@github.com>"
        
        git commit -m "$COMMIT_MSG" || exit 0
        git push
        
    - name: Generate build report
      if: steps.check_changes.outputs.lessons_changed == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        echo "## üìä Dictionary Update Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f src/data/dictionary-stats.json ]; then
          TOTAL_WORDS=$(cat src/data/dictionary-stats.json | jq -r '.totalUniqueWords')
          TOTAL_LESSONS=$(cat src/data/dictionary-stats.json | jq -r '.byLesson | length')
          echo "- **Total words:** $TOTAL_WORDS" >> $GITHUB_STEP_SUMMARY
          echo "- **Total lessons:** $TOTAL_LESSONS" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d src/data/internal/v1/dictionary/chunks ]; then
          CHUNK_COUNT=$(ls src/data/internal/v1/dictionary/chunks/*.json | wc -l)
          echo "- **Total chunks:** $CHUNK_COUNT" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üóÇÔ∏è Files Updated:" >> $GITHUB_STEP_SUMMARY
        git diff --name-only HEAD~1 HEAD | grep -E 'src/data/' | while read file; do
          echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Dictionary pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: update-dictionary
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build site
      run: npm run build
      
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        
    - name: Deployment summary
      run: |
        echo "## üöÄ Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Site built and deployed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "üåê **URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY