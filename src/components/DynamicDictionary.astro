---
export interface Props {
  language: string;
  initialWords?: number;
  availableLangs: Record<string, string>;
  baseUrl: string;
}

const { language, initialWords = 20, availableLangs, baseUrl } = Astro.props;
---

<div class="dynamic-dictionary" data-language={language}>
  <!-- Skeleton loader inicial -->
  <div class="dictionary-skeleton" id="dictionary-skeleton">
    <div class="skeleton-header">
      <div class="skeleton-text skeleton-title"></div>
      <div class="skeleton-text skeleton-subtitle"></div>
    </div>
    <div class="skeleton-search">
      <div class="skeleton-input"></div>
    </div>
    <div class="skeleton-grid">
      {Array.from({length: initialWords}, (_, i) => (
        <div class="skeleton-card" key={i}>
          <div class="skeleton-text skeleton-word"></div>
          <div class="skeleton-text skeleton-translation"></div>
          <div class="skeleton-text skeleton-source"></div>
        </div>
      ))}
    </div>
  </div>
  
  <!-- Contenido real (se carga din√°micamente) -->
  <div class="dictionary-content" id="dictionary-content" style="display: none;">
    <!-- El contenido se insertar√° aqu√≠ v√≠a JavaScript -->
  </div>
  
  <!-- Indicador de carga -->
  <div class="loading-indicator" id="loading-indicator" style="display: none;">
    <div class="spinner"></div>
    <p>Cargando vocabulario...</p>
  </div>
  
  <!-- Error handler -->
  <div class="error-message" id="error-message" style="display: none;">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Error cargando diccionario</h3>
    <p>No se pudo cargar el vocabulario. <button onclick="retryLoad()">Reintentar</button></p>
  </div>

  <!-- Modal para detalles de la palabra -->
  <div id="word-modal" class="modal" style="display: none !important;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>
</div>

<style is:global>
  /* Estilos base */
  .dynamic-dictionary { width: 100%; position: relative; }
  .dictionary-skeleton { animation: fadeIn 0.5s ease-in-out; }
  .skeleton-header { text-align: center; margin-bottom: var(--space-2xl); }
  .skeleton-text { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-md); }
  .skeleton-title { height: 3rem; width: 300px; margin: 0 auto var(--space-lg); }
  .skeleton-subtitle { height: 1.5rem; width: 200px; margin: 0 auto; }
  .skeleton-search { max-width: 500px; margin: 0 auto var(--space-2xl); }
  .skeleton-input { height: 3rem; width: 100%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-lg); }
  .skeleton-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--space-lg); }
  .skeleton-card { background: var(--color-paper); padding: var(--space-xl); border-radius: var(--radius-lg); border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); }
  .skeleton-word { height: 2rem; width: 60%; margin-bottom: var(--space-lg); }
  .skeleton-translation { height: 1rem; width: 80%; margin-bottom: var(--space-md); }
  .skeleton-source { height: 1rem; width: 40%; }
  @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .loading-indicator { text-align: center; padding: var(--space-3xl); display: flex; flex-direction: column; align-items: center; gap: var(--space-lg); }
  .spinner { width: 40px; height: 40px; border: 4px solid var(--color-border-light); border-top: 4px solid var(--color-revolutionary-red); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .error-message { text-align: center; padding: var(--space-3xl); background: var(--color-paper); border: 2px solid var(--color-border); border-radius: var(--radius-lg); color: var(--color-text-secondary); }
  .error-icon { font-size: 3rem; margin-bottom: var(--space-lg); }
  .error-message button { background: var(--color-revolutionary-red); color: white; border: none; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); cursor: pointer; font-weight: 600; margin-top: var(--space-md); }
  .error-message button:hover { background: var(--color-revolutionary-red-dark); }
  .dictionary-content { animation: slideIn 0.5s ease-out; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @media (max-width: 768px) { .skeleton-grid { grid-template-columns: 1fr; } .skeleton-title { width: 250px; } }

  .modal {
    position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.6);
    display: flex; align-items: center; justify-content: center;
  }
  .modal-content {
    background-color: var(--color-background);
    margin: auto; padding: var(--space-2xl);
    border: 1px solid var(--color-border);
    width: 80%; max-width: 700px; border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    position: relative;
  }
  .close-button {
    color: var(--color-text-secondary); float: right; font-size: 2rem; font-weight: bold;
    cursor: pointer;
  }
  .close-button:hover, .close-button:focus { color: var(--color-text-primary); }

  /* Estilos para el contenido din√°mico del diccionario */
  .dictionary-header { 
    text-align: center; 
    margin-bottom: var(--space-2xl); 
    padding-bottom: var(--space-lg);
    border-bottom: 2px solid var(--color-revolutionary-red-light);
  }
  .dictionary-header h2 { 
    color: var(--color-revolutionary-red); 
    margin-bottom: var(--space-md); 
    font-size: clamp(1.5rem, 4vw, 2rem);
  }
  .dictionary-header p { 
    color: var(--color-text-secondary); 
    font-size: 1.1rem; 
    font-weight: 500;
  }

  .search-section { 
    margin-bottom: var(--space-2xl); 
  }
  #word-search { 
    width: 100%; 
    max-width: 500px; 
    margin: 0 auto var(--space-lg); 
    display: block;
    padding: var(--space-md) var(--space-lg); 
    border: 2px solid var(--color-border); 
    border-radius: var(--radius-lg); 
    font-size: 1rem;
    font-family: var(--font-primary);
    transition: all 0.2s ease;
    background: var(--color-paper);
  }
  #word-search:focus { 
    outline: none; 
    border-color: var(--color-revolutionary-red); 
    box-shadow: 0 0 0 3px var(--color-revolutionary-red-light);
  }

  .alphabet-filter { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    gap: var(--space-sm); 
    margin-bottom: var(--space-lg);
  }
  .letter-btn { 
    background: var(--color-paper); 
    border: 2px solid var(--color-border); 
    color: var(--color-text-secondary); 
    padding: var(--space-sm) var(--space-md); 
    border-radius: var(--radius-md); 
    cursor: pointer; 
    font-weight: 500;
    font-family: var(--font-primary);
    transition: all 0.2s ease;
    min-width: 45px;
  }
  .letter-btn:hover { 
    background: var(--color-revolutionary-red-light); 
    border-color: var(--color-revolutionary-red); 
    color: var(--color-revolutionary-red-dark);
    transform: translateY(-1px);
  }
  .letter-btn.active { 
    background: var(--color-revolutionary-red); 
    border-color: var(--color-revolutionary-red); 
    color: white; 
    font-weight: 600;
  }

  .semantic-filter {
    margin-top: var(--space-lg);
    padding: var(--space-lg);
    background: var(--color-paper);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
  }
  .semantic-filter h4 {
    color: var(--color-revolutionary-red);
    margin-bottom: var(--space-md);
    font-size: 1.1rem;
    font-weight: 600;
  }
  .semantic-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }
  .semantic-btn {
    background: var(--color-paper);
    border: 2px solid var(--color-border);
    color: var(--color-text-secondary);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 500;
    font-family: var(--font-primary);
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }
  .semantic-btn:hover {
    background: var(--color-socialist-gold-light);
    border-color: var(--color-socialist-gold);
    color: var(--color-socialist-gold-dark);
    transform: translateY(-1px);
  }
  .semantic-btn.active {
    background: var(--color-socialist-gold);
    border-color: var(--color-socialist-gold);
    color: white;
    font-weight: 600;
  }

  .dictionary-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
    gap: var(--space-lg); 
  }
  .word-card { 
    background: var(--color-paper); 
    border: 1px solid var(--color-border); 
    border-radius: var(--radius-lg); 
    padding: var(--space-xl); 
    cursor: pointer; 
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
  }
  .word-card:hover { 
    transform: translateY(-2px); 
    box-shadow: var(--shadow-lg); 
    border-color: var(--color-revolutionary-red-light);
  }
  .word-title { 
    color: var(--color-revolutionary-red); 
    margin-bottom: var(--space-md); 
    font-size: 1.4rem;
    font-weight: 700;
  }
  .word-meta { 
    display: flex; 
    flex-direction: column; 
    gap: var(--space-sm); 
  }
  .word-meta span { 
    font-size: 0.9rem; 
    color: var(--color-text-secondary); 
  }
  .meaning { 
    color: var(--color-socialist-gold-dark); 
    font-weight: 600;
  }
  .lessons {
    color: var(--color-text-muted);
  }

  /* Estilos para el modal */
  .pinyin-syllable.tone-1 { color: #f44336; }
  .pinyin-syllable.tone-2 { color: #ff9800; }
  .pinyin-syllable.tone-3 { color: #4caf50; }
  .pinyin-syllable.tone-4 { color: #2196f3; }
  .pinyin-syllable.tone-5 { color: #9e9e9e; }

  .modal-entry {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }
  .modal-entry:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .modal-entry h4 {
    color: var(--color-revolutionary-red);
    margin: var(--space-md) 0 var(--space-sm) 0;
    font-size: 1.1rem;
  }
  .modal-entry ul {
    margin: 0;
    padding-left: var(--space-lg);
  }
  .modal-entry li {
    margin-bottom: var(--space-xs);
    color: var(--color-text-secondary);
  }
  .post-link {
    color: var(--color-revolutionary-red);
    text-decoration: none;
    font-weight: 500;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-revolutionary-red-light);
    border-radius: var(--radius-md);
    display: inline-block;
    margin-top: var(--space-sm);
    transition: all 0.2s ease;
  }
  .post-link:hover {
    background: var(--color-revolutionary-red);
    color: white;
    transform: translateY(-1px);
  }

  /* Estilos responsivos */
  @media (max-width: 768px) {
    .dictionary-grid { 
      grid-template-columns: 1fr; 
    }
    .alphabet-filter {
      gap: var(--space-xs);
    }
    .letter-btn {
      min-width: 40px;
      padding: var(--space-xs) var(--space-sm);
      font-size: 0.9rem;
    }
    #word-search {
      margin: 0 0 var(--space-lg) 0;
    }
  }
</style>

<script define:vars={{ language, availableLangs, baseUrl }}>
document.addEventListener('DOMContentLoaded', async function() {
  const container = document.querySelector('.dynamic-dictionary');
  const skeleton = document.getElementById('dictionary-skeleton');
  const contentEl = document.getElementById('dictionary-content');
  const loading = document.getElementById('loading-indicator');
  const error = document.getElementById('error-message');
  const modal = document.getElementById('word-modal');
  const modalBody = document.getElementById('modal-body');
  const closeModalBtn = document.querySelector('.close-button');

  let dictionaryData = null;
  let allWords = [];

  async function loadDictionaryData() {
    try {
      console.log(`üîç Cargando diccionario SIMPLIFICADO para: ${availableLangs[language]} (${language})`);
      
      // Mostrar loading despu√©s de 300ms si no ha cargado
      const loadingTimeout = setTimeout(() => {
        skeleton.style.display = 'none';
        loading.style.display = 'flex';
      }, 300);

      // NUEVA ARQUITECTURA: Carga directa desde lesson-words.json o kangxi-radicals-official.json
      let response, data;
      
      if (language === 'radical') {
        // Cargar radicales desde fuente de verdad √∫nica
        response = await fetch(`${baseUrl}data/chinese/kangxi-radicals-official.json`);
        if (!response.ok) throw new Error('No se pudo cargar kangxi-radicals-official.json');
        
        const radicalsData = await response.json();
        
        // Procesar radicales para el formato esperado por el frontend
        data = {
          meta: {
            language: 'radicales chinos',
            wordCount: radicalsData.radicals.length,
            lastUpdated: radicalsData.metadata.lastUpdated,
            generatedBy: 'DynamicDictionary.astro - lectura directa'
          },
          words: {}
        };
        
        // Convertir array de radicales a formato de palabras
        radicalsData.radicals.forEach(radical => {
          const key = radical.radical;
          data.words[key] = {
            entries: [{
              word: radical.radical,
              meaning: radical.meaning.es,
              source: 'kangxi-official',
              day: 0,
              lessons: [0],
              allTranslations: {
                es: radical.meaning.es,
                en: radical.meaning.en,
                de: radical.meaning.de,
                pt: radical.meaning.pt,
                ru: radical.meaning.ru,
                ruRom: radical.meaning.ru_rom || radical.meaning.ru,
                zh: radical.radical,
                zhPinyin: radical.meaning.zh_pinyin
              },
              metadata: {
                category: radical.category, // Usar la categor√≠a sem√°ntica real
                type: 'radical', // A√±adir tipo para distinguir de palabras
                number: radical.number,
                strokes: radical.strokes,
                unicode: radical.unicode,
                variants: radical.isVariant ? [radical.standardForm] : [],
                variantType: radical.variantType || null
              }
            }],
            frequency: 1,
            lessons: [0]
          };
        });
        
        allWords = Object.entries(data.words);
        dictionaryData = data;
        
      } else {
        // Cargar vocabulario de lecciones desde fuente de verdad √∫nica
        response = await fetch(`${baseUrl}data/lesson-words.json`);
        if (!response.ok) throw new Error('No se pudo cargar lesson-words.json');
        
        const lessonData = await response.json();
        
        // Procesar palabras para el idioma espec√≠fico
        data = {
          meta: {
            language: availableLangs[language],
            wordCount: 0,
            lastUpdated: lessonData.meta.lastUpdated,
            generatedBy: 'DynamicDictionary.astro - lectura directa'
          },
          words: {}
        };
        
        // Filtrar y procesar palabras por idioma
        lessonData.words.forEach(wordEntry => {
          const wordInLanguage = wordEntry[language];
          if (!wordInLanguage || wordInLanguage === '-' || wordInLanguage === '‚Äî') return;
          
          const key = wordInLanguage;
          data.words[key] = {
            entries: [{
              word: wordInLanguage,
              meaning: wordEntry.es, // Significado base siempre espa√±ol
              source: wordEntry.source,
              day: wordEntry.day,
              lessons: wordEntry.lessons,
              allTranslations: {
                es: wordEntry.es,
                en: wordEntry.en,
                de: wordEntry.de,
                pt: wordEntry.pt,
                ru: wordEntry.ru,
                ruRom: wordEntry.ruRom,
                zh: wordEntry.zh,
                zhPinyin: wordEntry.zhPinyin
              },
              metadata: {
                category: wordEntry.category,
                frequency: wordEntry.frequency,
                firstAppearance: wordEntry.firstAppearance,
                // Datos chinos si est√°n disponibles
                ...(wordEntry.zh && {
                  strokes: wordEntry.zhStrokes,
                  radical: wordEntry.zhRadical,
                  structure: wordEntry.zhStructure,
                  pinyin: wordEntry.zhPinyin
                })
              }
            }],
            frequency: wordEntry.frequency,
            lessons: wordEntry.lessons
          };
        });
        
        allWords = Object.entries(data.words);
        dictionaryData = data;
        data.meta.wordCount = allWords.length;
      }

      clearTimeout(loadingTimeout);
      
      console.log(`Diccionario cargado: ${allWords.length} palabras`);
      
      renderDictionary();
      
      skeleton.style.display = 'none';
      loading.style.display = 'none';
      error.style.display = 'none';
      contentEl.style.display = 'block';
      
    } catch (err) {
      console.error('Error cargando diccionario:', err);
      skeleton.style.display = 'none';
      loading.style.display = 'none';
      contentEl.style.display = 'none';
      error.style.display = 'block';
    }
  }
  
  function renderDictionary() {
    if (!dictionaryData) return;
    
    const letters = [...new Set(allWords.map(([word]) => word[0].toUpperCase()))].sort();

    contentEl.innerHTML = `
      <style>
        .dictionary-content .dictionary-header { 
          text-align: center; 
          margin-bottom: var(--space-2xl); 
          padding-bottom: var(--space-lg);
          border-bottom: 2px solid var(--color-revolutionary-red-light);
        }
        .dictionary-content .dictionary-header h2 { 
          color: var(--color-revolutionary-red); 
          margin-bottom: var(--space-md); 
          font-size: clamp(1.5rem, 4vw, 2rem);
        }
        .dictionary-content .dictionary-header p { 
          color: var(--color-text-secondary); 
          font-size: 1.1rem; 
          font-weight: 500;
        }
        .dictionary-content .search-section { 
          margin-bottom: var(--space-2xl); 
        }
        .dictionary-content #word-search { 
          width: 100%; 
          max-width: 500px; 
          margin: 0 auto var(--space-lg); 
          display: block;
          padding: var(--space-md) var(--space-lg); 
          border: 2px solid var(--color-border); 
          border-radius: var(--radius-lg); 
          font-size: 1rem;
          font-family: var(--font-primary);
          transition: all 0.2s ease;
          background: var(--color-paper);
        }
        .dictionary-content #word-search:focus { 
          outline: none; 
          border-color: var(--color-revolutionary-red); 
          box-shadow: 0 0 0 3px var(--color-revolutionary-red-light);
        }
        .dictionary-content .alphabet-filter { 
          display: flex; 
          flex-wrap: wrap; 
          justify-content: center; 
          gap: var(--space-sm); 
          margin-bottom: var(--space-lg);
        }
        .dictionary-content .letter-btn { 
          background: var(--color-paper); 
          border: 2px solid var(--color-border); 
          color: var(--color-text-secondary); 
          padding: var(--space-sm) var(--space-md); 
          border-radius: var(--radius-md); 
          cursor: pointer; 
          font-weight: 500;
          font-family: var(--font-primary);
          transition: all 0.2s ease;
          min-width: 45px;
        }
        .dictionary-content .letter-btn:hover { 
          background: var(--color-revolutionary-red-light); 
          border-color: var(--color-revolutionary-red); 
          color: var(--color-revolutionary-red-dark);
          transform: translateY(-1px);
        }
        .dictionary-content .letter-btn.active { 
          background: var(--color-revolutionary-red); 
          border-color: var(--color-revolutionary-red); 
          color: white; 
          font-weight: 600;
        }
        .dictionary-content .dictionary-grid { 
          display: grid; 
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
          gap: var(--space-lg); 
        }
        .dictionary-content .word-card { 
          background: var(--color-paper); 
          border: 1px solid var(--color-border); 
          border-radius: var(--radius-lg); 
          padding: var(--space-xl); 
          cursor: pointer; 
          transition: all 0.2s ease;
          box-shadow: var(--shadow-sm);
        }
        .dictionary-content .word-card:hover { 
          transform: translateY(-2px); 
          box-shadow: var(--shadow-lg); 
          border-color: var(--color-revolutionary-red-light);
        }
        .dictionary-content .word-title { 
          color: var(--color-revolutionary-red); 
          margin-bottom: var(--space-md); 
          font-size: 1.4rem;
          font-weight: 700;
        }
        .dictionary-content .word-meta { 
          display: flex; 
          flex-direction: column; 
          gap: var(--space-sm); 
        }
        .dictionary-content .word-meta span { 
          font-size: 0.9rem; 
          color: var(--color-text-secondary); 
        }
        .dictionary-content .meaning { 
          color: var(--color-socialist-gold-dark); 
          font-weight: 600;
        }
        .dictionary-content .lessons {
          color: var(--color-text-muted);
        }
        .dictionary-content .pronunciation {
          color: var(--color-revolutionary-red) !important;
          font-weight: 600;
          font-family: 'Courier New', monospace;
        }
        .dictionary-content .category {
          color: var(--color-anarchist-black) !important;
          font-weight: 500;
          font-style: italic;
        }
        .dictionary-content .semantic-category {
          color: var(--color-socialist-gold-dark) !important;
          font-weight: 600;
          font-style: italic;
        }
        @media (max-width: 768px) {
          .dictionary-content .dictionary-grid { 
            grid-template-columns: 1fr; 
          }
          .dictionary-content .alphabet-filter {
            gap: var(--space-xs);
          }
          .dictionary-content .letter-btn {
            min-width: 40px;
            padding: var(--space-xs) var(--space-sm);
            font-size: 0.9rem;
          }
          .dictionary-content #word-search {
            margin: 0 0 var(--space-lg) 0;
          }
        }
        
        /* Estilos para el modal */
        .modal {
          position: fixed !important;
          z-index: 1000 !important;
          left: 0 !important;
          top: 0 !important;
          width: 100% !important;
          height: 100% !important;
          overflow: auto !important;
          background-color: rgba(0,0,0,0.7) !important;
          align-items: center !important;
          justify-content: center !important;
        }
        .modal[style*="display: none"] {
          display: none !important;
        }
        .modal[style*="display: flex"] {
          display: flex !important;
        }
        .modal-content {
          background-color: var(--color-paper) !important;
          margin: auto !important;
          padding: var(--space-2xl) !important;
          border: 1px solid var(--color-border) !important;
          width: 90% !important;
          max-width: 800px !important;
          border-radius: var(--radius-lg) !important;
          box-shadow: var(--shadow-xl) !important;
          position: relative !important;
          max-height: 90vh !important;
          overflow-y: auto !important;
        }
        .close-button {
          color: var(--color-text-secondary) !important;
          float: right !important;
          font-size: 2rem !important;
          font-weight: bold !important;
          cursor: pointer !important;
          line-height: 1 !important;
          padding: var(--space-xs) !important;
        }
        .close-button:hover, .close-button:focus {
          color: var(--color-revolutionary-red) !important;
        }
        
        /* Estilos para la secci√≥n de trazos chinos */
        .stroke-section {
          margin-bottom: 1.5rem !important;
          padding: 1rem !important;
          background: #f8f9fa !important;
          border-radius: 8px !important;
          border: 1px solid #e9ecef !important;
        }
        .stroke-section h4 {
          margin-bottom: 1rem !important;
          color: var(--color-revolutionary-red) !important;
          font-size: 1.2rem !important;
          text-align: center !important;
        }
        .stroke-gifs {
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 0.75rem !important;
          justify-content: center !important;
        }
        .stroke-gif {
          text-align: center !important;
          transition: transform 0.2s ease !important;
        }
        .stroke-gif:hover {
          transform: scale(1.05) !important;
        }
        .stroke-gif img {
          width: 100px !important;
          height: 100px !important;
          border: 2px solid #ddd !important;
          border-radius: 6px !important;
          background: white !important;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
          transition: border-color 0.2s ease !important;
        }
        .stroke-gif img:hover {
          border-color: var(--color-revolutionary-red) !important;
        }
        .stroke-gif div {
          font-size: 1.2rem !important;
          color: #495057 !important;
          margin-top: 0.5rem !important;
          font-weight: 600 !important;
          font-family: 'SimSun', 'ÂÆã‰Ωì', serif !important;
        }
        .character-pinyin {
          font-size: 1.1rem !important;
          margin-top: 0.5rem !important;
          font-weight: 600 !important;
          font-family: 'Courier New', monospace !important;
        }
        /* Los colores de tonos tienen prioridad sobre character-pinyin */
        .character-pinyin.pinyin-syllable.tone-1 { color: #f44336 !important; }
        .character-pinyin.pinyin-syllable.tone-2 { color: #ff9800 !important; }
        .character-pinyin.pinyin-syllable.tone-3 { color: #4caf50 !important; }
        .character-pinyin.pinyin-syllable.tone-4 { color: #2196f3 !important; }
        .character-pinyin.pinyin-syllable.tone-5 { color: #9e9e9e !important; }
        
        /* Estilos para la secci√≥n de caracteres grandes */
        .chinese-large-display {
          text-align: center !important;
          margin-top: 1rem !important;
          padding: 0.75rem !important;
          background: white !important;
          border-radius: 6px !important;
          border: 1px solid #e9ecef !important;
        }
        .chinese-large-text {
          font-size: 2.5rem !important;
          font-weight: 300 !important;
          color: #2c3e50 !important;
          letter-spacing: 0.5rem !important;
          font-family: 'SimSun', 'ÂÆã‰Ωì', serif !important;
          line-height: 1.2 !important;
        }
        .stroke-attribution {
          margin-top: 0.75rem !important;
          text-align: center !important;
          color: #6c757d !important;
          font-size: 0.75rem !important;
        }
        .stroke-attribution a {
          color: #0066cc !important;
          text-decoration: none !important;
        }
        .stroke-attribution a:hover {
          text-decoration: underline !important;
        }
        .radical-analysis-section {
          margin-top: 1.5rem !important;
          padding-top: 1rem !important;
          border-top: 2px solid #e9ecef !important;
        }
        .radical-analysis-section h4 {
          color: #007bff !important;
          margin-bottom: 1rem !important;
          font-size: 1.1rem !important;
        }
        .radical-analyzer-container {
          background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
          border-radius: 8px !important;
          padding: 1rem !important;
          margin: 0.75rem 0 !important;
          border: 1px solid #dee2e6 !important;
        }
        .radical-loading-mini {
          display: flex !important;
          align-items: center !important;
          gap: 0.5rem !important;
          color: #6c757d !important;
          font-size: 0.9rem !important;
        }
        .loading-mini {
          width: 16px !important;
          height: 16px !important;
          border: 2px solid #e9ecef !important;
          border-top: 2px solid #007bff !important;
          border-radius: 50% !important;
          animation: spin-mini 1s linear infinite !important;
        }
        @keyframes spin-mini {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .radical-content {
          background: white !important;
          border-radius: 6px !important;
          padding: 0.75rem !important;
          border: 1px solid #dee2e6 !important;
        }
        .radical-header {
          text-align: center !important;
          margin-bottom: 1rem !important;
          padding-bottom: 0.5rem !important;
          border-bottom: 1px solid #e9ecef !important;
        }
        .radical-display {
          font-size: 1.5rem !important;
          font-family: 'SimSun', 'ÂÆã‰Ωì', serif !important;
          color: #007bff !important;
          margin: 0.25rem 0 !important;
        }
        .radical-meaning {
          color: #6c757d !important;
          font-style: italic !important;
          font-size: 0.85rem !important;
        }
        .radical-category {
          display: inline-block !important;
          background: #007bff !important;
          color: white !important;
          padding: 0.2rem 0.4rem !important;
          border-radius: 3px !important;
          font-size: 0.7rem !important;
          margin-top: 0.25rem !important;
        }
        .revolutionary-badge {
          display: inline-block !important;
          background: #dc3545 !important;
          color: white !important;
          padding: 0.2rem 0.4rem !important;
          border-radius: 3px !important;
          font-size: 0.7rem !important;
          margin-left: 0.5rem !important;
        }
        
        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
          .stroke-gif img {
            width: 80px !important;
            height: 80px !important;
          }
          .stroke-gifs {
            gap: 0.5rem !important;
          }
          .chinese-large-text {
            font-size: 2rem !important;
            letter-spacing: 0.3rem !important;
          }
        }
        @media (max-width: 480px) {
          .stroke-gif img {
            width: 70px !important;
            height: 70px !important;
          }
          .stroke-section {
            padding: 0.75rem !important;
          }
          .chinese-large-text {
            font-size: 1.8rem !important;
            letter-spacing: 0.2rem !important;
          }
        }
        .modal-entry {
          margin-bottom: var(--space-lg) !important;
          padding-bottom: var(--space-lg) !important;
          border-bottom: 1px solid var(--color-border) !important;
        }
        .modal-entry:last-child {
          border-bottom: none !important;
          margin-bottom: 0 !important;
          padding-bottom: 0 !important;
        }
        .modal-entry h4 {
          color: var(--color-revolutionary-red) !important;
          margin: var(--space-md) 0 var(--space-sm) 0 !important;
          font-size: 1.1rem !important;
        }
        .modal-entry ul {
          margin: 0 !important;
          padding-left: var(--space-lg) !important;
        }
        .modal-entry li {
          margin-bottom: var(--space-xs) !important;
          color: var(--color-text-secondary) !important;
        }
        .post-link {
          color: var(--color-revolutionary-red) !important;
          text-decoration: none !important;
          font-weight: 500 !important;
          padding: var(--space-sm) var(--space-md) !important;
          border: 1px solid var(--color-revolutionary-red-light) !important;
          border-radius: var(--radius-md) !important;
          display: inline-block !important;
          margin-top: var(--space-sm) !important;
          transition: all 0.2s ease !important;
        }
        .post-link:hover {
          background: var(--color-revolutionary-red) !important;
          color: white !important;
          transform: translateY(-1px) !important;
        }
        #modal-body h2 {
          color: var(--color-revolutionary-red) !important;
          margin-bottom: var(--space-lg) !important;
          font-size: 1.8rem !important;
          font-weight: 700 !important;
        }
        #modal-body p {
          color: var(--color-text-primary) !important;
          line-height: 1.6 !important;
          margin-bottom: var(--space-md) !important;
        }
        #modal-body strong {
          color: var(--color-text-primary) !important;
          font-weight: 600 !important;
        }
      </style>
      <div class="dictionary-header">
        <h2>Vocabulario de ${availableLangs[language] || language}</h2>
        <p>${allWords.length} palabras encontradas</p>
      </div>
      <div class="search-section">
        <input type="text" id="word-search" placeholder="Buscar palabras..." />
        <div class="alphabet-filter" id="alphabet-filter">
          <button class="letter-btn active" data-letter="all">Todos</button>
          ${letters.map(letter => 
            `<button class="letter-btn" data-letter="${letter}">${letter}</button>`
          ).join('')}
        </div>
        ${language === 'radical' ? `
        <div class="semantic-filter" id="semantic-filter">
          <h4>Filtrar por categor√≠a:</h4>
          <div class="semantic-buttons">
            <button class="semantic-btn active" data-semantic="all">Todos</button>
            <button class="semantic-btn" data-semantic="abstracto">Abstracto</button>
            <button class="semantic-btn" data-semantic="actividad">Actividad</button>
            <button class="semantic-btn" data-semantic="animal">Animal</button>
            <button class="semantic-btn" data-semantic="cuerpo">Cuerpo</button>
            <button class="semantic-btn" data-semantic="forma">Forma</button>
            <button class="semantic-btn" data-semantic="general">General</button>
            <button class="semantic-btn" data-semantic="herramienta">Herramienta</button>
            <button class="semantic-btn" data-semantic="humano">Humano</button>
            <button class="semantic-btn" data-semantic="material">Material</button>
            <button class="semantic-btn" data-semantic="naturaleza">Naturaleza</button>
            <button class="semantic-btn" data-semantic="n√∫mero">N√∫mero</button>
          </div>
        </div>
        ` : ''}
      </div>
      
      <!-- Enlaces a b√∫squeda por radicales para idiomas chinos -->
      <div class="dictionary-grid" id="dictionary-grid">
        ${allWords.map(([word, data]) => {
          const details = JSON.stringify(data).replace(/'/g, '&apos;');
          const entry = data.entries?.[0];
          const category = entry?.metadata?.category;
          const semanticAttr = (language === 'radical' && category) ? `data-semantic="${category}"` : '';
          const pinyin = entry?.allTranslations?.zhPinyin;
          const strokes = entry?.metadata?.strokes;
          const meaning = entry?.meaning || data.meaning || 'Sin significado'; // Fallback para evitar undefined
          
          return `
            <div class="word-card" data-word-raw="${word}" data-word-details='${details}' data-letter="${word[0].toUpperCase()}" ${semanticAttr}>
              <h3 class="word-title">${word}</h3>
              <div class="word-meta">
                <span class="meaning">${language === 'es' ? `Primera aparici√≥n: D√≠a ${data.firstAppearance}` : `Significado: ${meaning}`}</span>
                ${language === 'radical' && pinyin ? `<span class="pronunciation">Pinyin: ${pinyin}</span>` : ''}
                ${language === 'radical' && strokes ? `<span class="category">Trazos: ${strokes}</span>` : ''}
                ${language === 'radical' && category ? `<span class="semantic-category">Tipo: ${category}</span>` : ''}
                <span class="lessons">Lecciones: ${data.lessons.join(', ')}</span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function setupEventListeners() {
    const searchInput = document.getElementById('word-search');
    const dictionaryGrid = document.getElementById('dictionary-grid');
    const alphabetFilter = document.getElementById('alphabet-filter');

    searchInput?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      document.querySelectorAll('.word-card').forEach(card => {
        const word = card.dataset.wordRaw.toLowerCase();
        card.style.display = word.includes(query) ? '' : 'none';
      });
      alphabetFilter.querySelector('.active')?.classList.remove('active');
    });

    alphabetFilter?.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const letter = e.target.dataset.letter;

        alphabetFilter.querySelector('.active')?.classList.remove('active');
        e.target.classList.add('active');

        // Reset semantic filter
        const semanticFilter = document.getElementById('semantic-filter');
        if (semanticFilter) {
            semanticFilter.querySelector('.active')?.classList.remove('active');
            semanticFilter.querySelector('[data-semantic="all"]')?.classList.add('active');
        }

        document.querySelectorAll('.word-card').forEach(card => {
            if (letter === 'all' || card.dataset.letter === letter) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
        searchInput.value = '';
    });

    // Event listener para filtro sem√°ntico (solo para radicales)
    const semanticFilter = document.getElementById('semantic-filter');
    semanticFilter?.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const semantic = e.target.dataset.semantic;

        semanticFilter.querySelector('.active')?.classList.remove('active');
        e.target.classList.add('active');

        // Reset alphabet filter
        alphabetFilter.querySelector('.active')?.classList.remove('active');
        alphabetFilter.querySelector('[data-letter="all"]')?.classList.add('active');

        document.querySelectorAll('.word-card').forEach(card => {
            if (semantic === 'all' || card.dataset.semantic === semantic) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
        searchInput.value = '';
    });

    dictionaryGrid?.addEventListener('click', (e) => {
      const card = e.target.closest('.word-card');
      if (card) {
        console.log('Word card clicked:', card.dataset.wordRaw);
        const details = JSON.parse(card.dataset.wordDetails.replace(/&apos;/g, "'"));
        showWordDetails(card.dataset.wordRaw, details);
      }
    });

    // Event listeners para modal
    const modal = document.getElementById('word-modal');
    const closeButton = modal?.querySelector('.close-button');
    
    closeButton?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
    
    // Los enlaces a radicales no necesitan JavaScript adicional
  }

  // Base de datos de trazos para caracteres individuales comunes
  const characterStrokes = {
    // Radicales b√°sicos
    "‰∫∫": 2, "Âè£": 3, "Âúü": 3, "Â∑•": 3, "Â§ß": 3, "Â∞è": 3, "Â±±": 3, "Â∑ù": 3,
    "Êú®": 4, "Ê∞¥": 4, "ÁÅ´": 4, "Êó•": 4, "Êúà": 4, "ÂøÉ": 4, "Êâã": 4, "ÁõÆ": 5,
    "Áî∞": 5, "ÁôΩ": 5, "Áü≥": 5, "Á´ã": 5, "Á§∫": 5, "Á¶æ": 5, "Á©¥": 5, "Á´π": 6,
    "Á±≥": 6, "Á≥∏": 6, "ËÄ≥": 6, "ËÇâ": 6, "Ëá£": 6, "Ëá™": 6, "Ëá≥": 6, "Ëàå": 6,
    "Ëô´": 6, "Ë°Ä": 6, "Ë°å": 6, "Ë°£": 6, "Ë¶ã": 7, "Ë®Ä": 7, "Ë∞∑": 7, "Ë±Ü": 7,
    "Ë±ï": 7, "Ëµ∞": 7, "Ë∂≥": 7, "Ë∫´": 7, "Ëªä": 7, "Ëæõ": 7, "Ëæ∞": 7, "ÈÖâ": 7,
    "ÈáÜ": 7, "Èáå": 7, "Èáë": 8, "Èï∑": 8, "ÈñÄ": 8, "Èòú": 8, "Èö∂": 8, "Èöπ": 8,
    "Èõ®": 8, "Èùí": 8, "Èùû": 8, "Èù¢": 9, "Èù©": 9, "Èüã": 9, "Èü≠": 9, "Èü≥": 9,
    "È†Å": 9, "È¢®": 9, "È£õ": 9, "È£ü": 9, "È¶ñ": 9, "È¶ô": 9, "È¶¨": 10, "È™®": 10,
    "È´ò": 10, "È´ü": 10, "È¨•": 10, "È¨Ø": 10, "È¨≤": 10, "È¨º": 10, "È≠ö": 11,
    "È≥•": 11, "Èπµ": 11, "Èπø": 11, "È∫ª": 11, "ÈªÉ": 12, "Èªç": 12, "Èªë": 12,
    "Èªπ": 12, "ÈªΩ": 13, "Èºé": 13, "Èºì": 13, "Èº†": 13, "Èºª": 14, "ÈΩä": 14,
    "ÈΩí": 15, "Èæç": 16, "Èæú": 16, "Èæ†": 17,
    
    // Caracteres revolucionarios comunes
    "Âèç": 4, "Êäó": 7, "Èù©": 9, "ÂëΩ": 8, "Ê∞ë": 5, "ÂõΩ": 8, "ÂÖö": 10, "Êîø": 9,
    "ÊùÉ": 6, "Êñó": 4, "‰∫â": 6, "Êàò": 9, "ËÉú": 9, "Âà©": 7, "Âäõ": 2, "ÂÜú": 6,
    "Âú∞": 6, "‰∏ª": 5, "‰πâ": 3, "Ëá™": 6, "Áî±": 5, "Âõ¢": 6, "Áªì": 9, "Ëß£": 13,
    "Êîæ": 8, "ËÅî": 12, "Áõü": 13, "Á§æ": 7, "‰ºö": 6, "Âä≥": 7, "‰Ωú": 7, "Ëµ∑": 10,
    "Êù•": 7, "ÊùÉ": 6, "Âà©": 7, "Êñó": 4, "‰∫â": 6, "Êàò": 9, "ËÉú": 9,
    
    // N√∫meros b√°sicos
    "‰∏Ä": 1, "‰∫å": 2, "‰∏â": 3, "Âõõ": 5, "‰∫î": 4, "ÂÖ≠": 4, "‰∏É": 2, "ÂÖ´": 2,
    "‰πù": 2, "ÂçÅ": 2, "Áôæ": 6, "ÂçÉ": 3, "‰∏á": 3,
    
    // Otros caracteres comunes del vocabulario
    "Ê≠å": 14, "Êõ≤": 6, "Âî±": 11, "Êóó": 14, "Â∏ú": 8, "Á∫¢": 9, "Èªë": 12, "ÁôΩ": 5,
    "Èùí": 8, "ÈªÑ": 11, "Áªø": 11, "Á¥´": 12, "Ëìù": 13, "ÁÅ∞": 6, "Ê£ï": 12,
    "‰∏ú": 5, "Ë•ø": 6, "Âçó": 9, "Âåó": 5, "‰∏ä": 3, "‰∏ã": 3, "Â∑¶": 5, "Âè≥": 5,
    "Ââç": 9, "Âêé": 6, "‰∏≠": 4, "ÂÜÖ": 4, "Â§ñ": 5, "Èáå": 7, "Ëæπ": 5, "Èó¥": 7,
    "Âπ¥": 6, "Êúà": 4, "Êó•": 4, "Êó∂": 7, "ÂàÜ": 4, "Áßí": 9, "‰ªä": 4, "Êòé": 8,
    "Êò®": 9, "Êó©": 6, "Êôö": 11, "Â§ú": 8, "Âçà": 4, "Êô®": 11, "Â§ï": 3, "Êúù": 12
  };

  

  // Funci√≥n para convertir caracteres chinos a c√≥digos Unicode decimales - ARCHIVOS LOCALES
    

    function getToneClass(pinyin) {
    if (/[ƒÅƒìƒ´≈ç≈´]/.test(pinyin)) return 'tone-1';
    if (/[√°√©√≠√≥√∫]/.test(pinyin)) return 'tone-2';
    if (/[«éƒõ«ê«í«î]/.test(pinyin)) return 'tone-3';
    if (/[√†√®√¨√≤√π]/.test(pinyin)) return 'tone-4';
    return 'tone-5';
  }

  function renderPinyinWithTones(pinyin) {
    if (!pinyin) return '';
    return pinyin.split(/\s+/).map(syllable => 
      `<span class="pinyin-syllable ${getToneClass(syllable)}">${syllable}</span>`
    ).join(' ');
  }

    let characterData = {};

  async function loadCharacterData() {
    try {
      const response = await fetch(`${baseUrl}data/chinese/character-data.json`);
      if (!response.ok) throw new Error('No se pudo cargar los datos de los caracteres');
      characterData = await response.json();
    } catch (err) {
      console.error('Error cargando los datos de los caracteres:', err);
    }
  }

  function getChineseStrokeGifs(chineseText) {
    if (!chineseText || typeof chineseText !== 'string') return [];
    
    const gifs = [];
    for (let i = 0; i < chineseText.length; i++) {
      const char = chineseText[i];
      if (/[\u4e00-\u9fff]/.test(char)) {
        const unicodeDecimal = char.codePointAt(0);
        // Usar datos CC-CEDICT para informaci√≥n del car√°cter
        const charData = characterData?.characters?.[char] || {};
        gifs.push({
          char: char,
          pinyin: charData.pinyin || '',
          url: `${baseUrl}data/chinese/strokes/${charData.file || `${unicodeDecimal}.gif`}`,
          attribution: "MDBG Chinese Dictionary (mdbg.net)",
          definitions: charData.definitions || [],
          traditional: charData.traditional || char
        });
      }
    }
    return gifs;
  }

  function showWordDetails(word, data) {
    // NUEVA ARQUITECTURA SIMPLIFICADA: Mostrar detalles con estructura unificada
    console.log('üîç Mostrando detalles de:', word, data);
    
    let detailsHtml = `<h2>${word}</h2>`;

    // NUEVA ARQUITECTURA: Estructura unificada de entries
    if (data.entries && data.entries.length > 0) {
      const entry = data.entries[0]; // Usar primera entrada
      
      detailsHtml += `<div class="modal-entry">`;
      detailsHtml += `<p><strong>Significado:</strong> ${entry.meaning}</p>`;
      
      // Informaci√≥n espec√≠fica por tipo
      if (entry.metadata && entry.metadata.type === 'radical') {
        // RADICAL: Mostrar informaci√≥n espec√≠fica de radical
        detailsHtml += `<h4>üìã Informaci√≥n del Radical</h4>`;
        
        if (entry.metadata.number) {
          detailsHtml += `<p><strong>N√∫mero Kangxi:</strong> ${entry.metadata.number}/214</p>`;
        }
        if (entry.metadata.strokes) {
          detailsHtml += `<p><strong>Trazos:</strong> ${entry.metadata.strokes}</p>`;
        }
        if (entry.metadata.unicode) {
          detailsHtml += `<p><strong>Unicode:</strong> U+${entry.metadata.unicode.toString(16).toUpperCase().padStart(4, '0')}</p>`;
        }
        if (entry.metadata.variants && entry.metadata.variants.length > 0) {
          detailsHtml += `<p><strong>Forma est√°ndar:</strong> ${entry.metadata.variants[0]}</p>`;
        }
        if (entry.metadata.variantType) {
          detailsHtml += `<p><strong>Posici√≥n:</strong> ${entry.metadata.variantType}</p>`;
        }
        
      } else {
        // PALABRA REGULAR: Mostrar informaci√≥n de vocabulario
        detailsHtml += `<h4>üìö Informaci√≥n de la Palabra</h4>`;
        
        if (entry.metadata && entry.metadata.category) {
          detailsHtml += `<p><strong>Categor√≠a:</strong> ${entry.metadata.category}</p>`;
        }
        if (entry.lessons && entry.lessons.length > 0) {
          const lessonsList = entry.lessons.sort((a, b) => a - b).join(', ');
          detailsHtml += `<p><strong>Aparece en lecciones:</strong> ${lessonsList}</p>`;
        }
        if (entry.metadata && entry.metadata.frequency > 1) {
          detailsHtml += `<p><strong>Frecuencia:</strong> ${entry.metadata.frequency} lecciones</p>`;
        }
        if (entry.source) {
          detailsHtml += `<p><strong>Fuente:</strong> ${entry.source}</p>`;
        }
      }
      
      // TRADUCCIONES: Mostrar todas las traducciones disponibles
      if (entry.allTranslations) {
        detailsHtml += `<h4>üåç Traducciones</h4>`;
        
        const translations = [
          { code: 'es', name: 'Espa√±ol', value: entry.allTranslations.es },
          { code: 'en', name: 'English', value: entry.allTranslations.en },
          { code: 'de', name: 'Deutsch', value: entry.allTranslations.de },
          { code: 'pt', name: 'Portugu√™s', value: entry.allTranslations.pt },
          { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', value: entry.allTranslations.ru },
          { code: 'ruRom', name: '–†—É—Å—Å–∫–∏–π Rom.', value: entry.allTranslations.ruRom },
          { code: 'zh', name: '‰∏≠Êñá', value: entry.allTranslations.zh },
          { code: 'zhPinyin', name: 'Pinyin', value: entry.allTranslations.zhPinyin }
        ];
        
        translations.forEach(trans => {
          if (trans.value && trans.value !== '-' && trans.value !== '‚Äî') {
            detailsHtml += `<p><strong>${trans.name}:</strong> ${trans.value}</p>`;
          }
        });
      }
      
      // DATOS CHINOS: Si tiene informaci√≥n china espec√≠fica
      if (entry.metadata && (entry.metadata.strokes || entry.metadata.radical || entry.metadata.pinyin)) {
        detailsHtml += `<h4>üà≥ Informaci√≥n China</h4>`;
        
        if (entry.metadata.strokes) {
          detailsHtml += `<p><strong>Trazos:</strong> ${entry.metadata.strokes}</p>`;
        }
        if (entry.metadata.radical) {
          detailsHtml += `<p><strong>Radical:</strong> ${entry.metadata.radical}</p>`;
        }
        if (entry.metadata.structure) {
          detailsHtml += `<p><strong>Estructura:</strong> ${entry.metadata.structure}</p>`;
        }
        if (entry.metadata.pinyin) {
          // Procesar pinyin con tonos coloreados
          const pinyinWithTones = entry.metadata.pinyin.replace(/([aeiou√ºv])([ÃÑÃÅÃåÃÄ]?)/g, (match, vowel, tone) => {
            const toneClass = {
              'ÃÑ': 'tone-1', 'ÃÅ': 'tone-2', 'Ãå': 'tone-3', 'ÃÄ': 'tone-4'
            }[tone] || 'tone-5';
            return `<span class="pinyin-syllable ${toneClass}">${match}</span>`;
          });
          detailsHtml += `<p><strong>Pinyin:</strong> ${pinyinWithTones}</p>`;
        }
      }
      
      // ENLACES A LECCIONES
      if (entry.lessons && entry.lessons.length > 0) {
        detailsHtml += `<h4>üîó Enlaces</h4>`;
        if (entry.lessons.length === 1) {
          detailsHtml += `<p><a href="${baseUrl}blog/${entry.source}/" class="post-link">Ver en la lecci√≥n del d√≠a ${entry.lessons[0]}</a></p>`;
        } else {
          detailsHtml += `<p><strong>Aparece en las lecciones:</strong> `;
          entry.lessons.forEach((day, idx) => {
            if (idx > 0) detailsHtml += ', ';
            detailsHtml += `<a href="${baseUrl}blog/dia-${day.toString().padStart(2, '0')}/" class="post-link">D√≠a ${day}</a>`;
          });
          detailsHtml += `</p>`;
        }
      }
      
      detailsHtml += `</div>`;
    } else {
      // Fallback para datos sin estructura entries
      detailsHtml += `<div class="modal-entry">`;
      detailsHtml += `<p><strong>Error:</strong> No se pudo cargar la informaci√≥n de la palabra.</p>`;
      detailsHtml += `<p>Datos recibidos: ${JSON.stringify(data, null, 2)}</p>`;
      detailsHtml += `</div>`;
    }

    // NUEVA ARQUITECTURA: Trazos chinos simplificados
    const containsChinese = /[\u4e00-\u9fff]/.test(word) || 
                           (data.entries?.[0]?.allTranslations?.zh && /[\u4e00-\u9fff]/.test(data.entries[0].allTranslations.zh));
    
    if ((language === 'zh' || language === 'zh-pinyin' || language === 'radical' || containsChinese) && data.entries && data.entries[0]) {
      const entry = data.entries[0];
      let chineseText = '';
      
      // Determinar texto chino a mostrar
      if (language === 'zh' || language === 'radical') {
        chineseText = word;
      } else if (entry.allTranslations && entry.allTranslations.zh) {
        chineseText = entry.allTranslations.zh;
      }
      
      if (chineseText && /[\u4e00-\u9fff]/.test(chineseText)) {
        // Generar GIFs de trazos
        const strokeGifs = getChineseStrokeGifs(chineseText);
        
        if (strokeGifs.length > 0) {
          detailsHtml += `<div class="stroke-section">`;
          detailsHtml += `<h4>‚úçÔ∏è Orden de trazos</h4>`;
          detailsHtml += `<div class="stroke-gifs">`;
          
          strokeGifs.forEach((gif, idx) => {
            detailsHtml += `<div class="stroke-gif">`;
            detailsHtml += `<img src="${gif.url}" alt="Trazos de ${gif.char}" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'width:100px;height:100px;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#999;font-size:0.8rem;text-align:center;\\'>No disponible<br>${gif.char}</div>'">`;
            detailsHtml += `<div class="character-pinyin">${gif.char}</div>`;
            detailsHtml += `</div>`;
          });
          
          detailsHtml += `</div>`;
          detailsHtml += `<div class="stroke-attribution">`;
          detailsHtml += `<small>Orden de trazos ¬© <a href="https://www.mdbg.net/" target="_blank" rel="noopener">MDBG Chinese Dictionary</a></small>`;
          detailsHtml += `</div>`;
          detailsHtml += `</div>`;
        }
      }
    }



    const modalBody = document.getElementById('modal-body');
    if (!modalBody) {
      console.error('Modal body element not found!');
      return;
    }
    modalBody.innerHTML = detailsHtml;
    
    // Cargar an√°lisis de radicales para caracteres chinos
    loadRadicalAnalysis();
    
    const currentModal = document.getElementById('word-modal');
    if (currentModal) {
      console.log('Setting modal display to flex');
      currentModal.style.setProperty('display', 'flex', 'important');
    } else {
      console.error('Modal element not found!');
    }
  }

  function closeModal() {
    const currentModal = document.getElementById('word-modal');
    if (currentModal) {
      currentModal.style.setProperty('display', 'none', 'important');
    }
  }

  async function init() {
    // Asegurarse de que el modal est√© oculto al inicio
    const currentModal = document.getElementById('word-modal');
    if (currentModal) {
      currentModal.style.setProperty('display', 'none', 'important');
    }
    
    await loadDictionaryData();
    await loadCharacterData();
    setupEventListeners();
    
    // Configurar event listeners del modal despu√©s de cargar el contenido
    setupModalListeners();
  }

  function setupModalListeners() {
    // Limpiar listeners previos
    const newCloseBtn = document.querySelector('.close-button');
    const newModal = document.getElementById('word-modal');
    
    if (newCloseBtn) {
      newCloseBtn.addEventListener('click', closeModal);
    }
    
    if (newModal) {
      newModal.addEventListener('click', (e) => {
        if (e.target === newModal) {
          closeModal();
        }
      });
    }
  }
  
  // Base de datos de radicales Kangxi reales para caracteres individuales
  const kangxiRadicals = {
    // Radicales que son caracteres por s√≠ mismos
    "Âúü": { radical: "Âúü", meaning: "tierra", strokes: 3, radicalStrokes: 3 },
    "‰∫∫": { radical: "‰∫∫", meaning: "persona", strokes: 2, radicalStrokes: 2 },
    "Â∑•": { radical: "Â∑•", meaning: "trabajo", strokes: 3, radicalStrokes: 3 },
    "Êú®": { radical: "Êú®", meaning: "√°rbol", strokes: 4, radicalStrokes: 4 },
    "Ê∞¥": { radical: "Ê∞¥", meaning: "agua", strokes: 4, radicalStrokes: 4 },
    "ÁÅ´": { radical: "ÁÅ´", meaning: "fuego", strokes: 4, radicalStrokes: 4 },
    "Èáë": { radical: "Èáë", meaning: "metal", strokes: 8, radicalStrokes: 8 },
    "Âè£": { radical: "Âè£", meaning: "boca", strokes: 3, radicalStrokes: 3 },
    "ÂøÉ": { radical: "ÂøÉ", meaning: "coraz√≥n", strokes: 4, radicalStrokes: 4 },
    "Êâã": { radical: "Êâã", meaning: "mano", strokes: 4, radicalStrokes: 4 },
    "Êó•": { radical: "Êó•", meaning: "sol", strokes: 4, radicalStrokes: 4 },
    "Êúà": { radical: "Êúà", meaning: "luna", strokes: 4, radicalStrokes: 4 },
    
    // Caracteres compuestos con sus radicales reales
    "Âú∞": { radical: "Âúü", meaning: "tierra", strokes: 6, radicalStrokes: 3 },
    "ÂõΩ": { radical: "Âõó", meaning: "recinto", strokes: 8, radicalStrokes: 3 },
    "Ê∞ë": { radical: "Ê∞è", meaning: "clan", strokes: 5, radicalStrokes: 4 },
    "ÂÜú": { radical: "Ëæ∞", meaning: "tiempo", strokes: 6, radicalStrokes: 7 },
    "Â∑•‰∫∫": { radical: "Â∑•", meaning: "trabajo", strokes: 7, radicalStrokes: 3 },
    "Âèç": { radical: "ÂéÇ", meaning: "acantilado", strokes: 4, radicalStrokes: 2 },
    "Êäó": { radical: "Êâã", meaning: "mano", strokes: 7, radicalStrokes: 4 },
    "Èù©": { radical: "Èù©", meaning: "cuero", strokes: 9, radicalStrokes: 9 },
    "ÂëΩ": { radical: "Âè£", meaning: "boca", strokes: 8, radicalStrokes: 3 },
    "ÊùÉ": { radical: "Êú®", meaning: "√°rbol", strokes: 6, radicalStrokes: 4 },
    "Âà©": { radical: "ÂàÄ", meaning: "cuchillo", strokes: 7, radicalStrokes: 2 },
    "Âäõ": { radical: "Âäõ", meaning: "fuerza", strokes: 2, radicalStrokes: 2 },
    "Êñó": { radical: "Êñó", meaning: "lucha", strokes: 4, radicalStrokes: 4 },
    "‰∫â": { radical: "Áà™", meaning: "garra", strokes: 6, radicalStrokes: 4 },
    "Êàò": { radical: "Êàà", meaning: "lanza", strokes: 9, radicalStrokes: 4 },
    "ËÉú": { radical: "Êúà", meaning: "carne", strokes: 9, radicalStrokes: 4 },
    "Âõ¢": { radical: "Âõó", meaning: "recinto", strokes: 6, radicalStrokes: 3 },
    "Áªì": { radical: "Á≥∏", meaning: "seda", strokes: 9, radicalStrokes: 6 },
    "Ëß£": { radical: "Ëßí", meaning: "cuerno", strokes: 13, radicalStrokes: 7 },
    "Êîæ": { radical: "Êî¥", meaning: "golpear", strokes: 8, radicalStrokes: 4 },
    "ËÅî": { radical: "ËÄ≥", meaning: "oreja", strokes: 12, radicalStrokes: 6 },
    "Áõü": { radical: "Áöø", meaning: "recipiente", strokes: 13, radicalStrokes: 5 },
    "Á§æ": { radical: "Á§∫", meaning: "sagrado", strokes: 7, radicalStrokes: 5 },
    "‰ºö": { radical: "‰∫∫", meaning: "persona", strokes: 6, radicalStrokes: 2 },
    "Âä≥": { radical: "Âäõ", meaning: "fuerza", strokes: 7, radicalStrokes: 2 },
    "‰Ωú": { radical: "‰∫∫", meaning: "persona", strokes: 7, radicalStrokes: 2 },
    "Ëµ∑": { radical: "Ëµ∞", meaning: "caminar", strokes: 10, radicalStrokes: 7 },
    "Êù•": { radical: "Êú®", meaning: "√°rbol", strokes: 7, radicalStrokes: 4 },
    "Ëá™": { radical: "Ëá™", meaning: "uno mismo", strokes: 6, radicalStrokes: 6 },
    "Áî±": { radical: "Áî∞", meaning: "campo", strokes: 5, radicalStrokes: 5 },
    "‰∏ª": { radical: "‰∏∂", meaning: "punto", strokes: 5, radicalStrokes: 1 },
    "‰πâ": { radical: "‰∏∂", meaning: "punto", strokes: 3, radicalStrokes: 1 },
    "Á∫¢": { radical: "Á≥∏", meaning: "seda", strokes: 9, radicalStrokes: 6 },
    "Êóó": { radical: "Êñπ", meaning: "cuadrado", strokes: 14, radicalStrokes: 4 },
    "Â∏ú": { radical: "Â∑æ", meaning: "pa√±o", strokes: 8, radicalStrokes: 3 },
    
    // Caracteres adicionales del vocabulario
    "‰∏Ä": { radical: "‰∏Ä", meaning: "uno", strokes: 1, radicalStrokes: 1 },
    "‰∏ã": { radical: "‰∏Ä", meaning: "uno", strokes: 3, radicalStrokes: 1 },
    "‰∏ç": { radical: "‰∏Ä", meaning: "uno", strokes: 4, radicalStrokes: 1 },
    "‰∏ñ": { radical: "‰∏Ä", meaning: "uno", strokes: 5, radicalStrokes: 1 },
    "‰∏ú": { radical: "Êú®", meaning: "√°rbol", strokes: 5, radicalStrokes: 4 },
    "‰∏ª": { radical: "‰∏∂", meaning: "punto", strokes: 5, radicalStrokes: 1 },
    "‰∏æ": { radical: "‰∏∂", meaning: "punto", strokes: 9, radicalStrokes: 1 },
    "‰πà": { radical: "‰∏ø", meaning: "l√≠nea", strokes: 3, radicalStrokes: 1 },
    "‰πã": { radical: "‰∏∂", meaning: "punto", strokes: 3, radicalStrokes: 1 },
    "‰π¶": { radical: "‰πô", meaning: "segundo", strokes: 4, radicalStrokes: 1 },
    "‰∫â": { radical: "Áà™", meaning: "garra", strokes: 6, radicalStrokes: 4 },
    "‰∫í": { radical: "‰∫å", meaning: "dos", strokes: 4, radicalStrokes: 2 },
    "‰∫°": { radical: "‰∫†", meaning: "techo", strokes: 3, radicalStrokes: 2 },
    "‰∫ß": { radical: "‰∫†", meaning: "techo", strokes: 6, radicalStrokes: 2 },
    "‰ªÄ": { radical: "‰∫∫", meaning: "persona", strokes: 4, radicalStrokes: 2 },
    "‰ª¨": { radical: "‰∫∫", meaning: "persona", strokes: 5, radicalStrokes: 2 },
    "‰ºö": { radical: "‰∫∫", meaning: "persona", strokes: 6, radicalStrokes: 2 },
    "‰ºü": { radical: "‰∫∫", meaning: "persona", strokes: 6, radicalStrokes: 2 },
    "‰Ωú": { radical: "‰∫∫", meaning: "persona", strokes: 7, radicalStrokes: 2 },
    "ÂÖâ": { radical: "ÂÑø", meaning: "ni√±o", strokes: 6, radicalStrokes: 2 },
    "ÂÖö": { radical: "ÂÑø", meaning: "ni√±o", strokes: 10, radicalStrokes: 2 },
    "ÂÖ¨": { radical: "ÂÖ´", meaning: "ocho", strokes: 4, radicalStrokes: 2 },
    "ÂÖ±": { radical: "ÂÖ´", meaning: "ocho", strokes: 6, radicalStrokes: 2 },
    "ÂÖµ": { radical: "ÂÖ´", meaning: "ocho", strokes: 7, radicalStrokes: 2 },
    "ÂÜô": { radical: "ÂÜñ", meaning: "cubierta", strokes: 5, radicalStrokes: 2 },
    "ÂÜõ": { radical: "ÂÜñ", meaning: "cubierta", strokes: 6, radicalStrokes: 2 },
    "ÂÜú": { radical: "ÂÜñ", meaning: "cubierta", strokes: 6, radicalStrokes: 2 },
    "Âá∫": { radical: "Âáµ", meaning: "recipiente", strokes: 5, radicalStrokes: 2 },
    "Âáª": { radical: "Âáµ", meaning: "recipiente", strokes: 7, radicalStrokes: 2 },
    "Âà©": { radical: "ÂàÄ", meaning: "cuchillo", strokes: 7, radicalStrokes: 2 },
    "Ââç": { radical: "ÂàÄ", meaning: "cuchillo", strokes: 9, radicalStrokes: 2 },
    "Âäõ": { radical: "Âäõ", meaning: "fuerza", strokes: 2, radicalStrokes: 2 },
    "Âä®": { radical: "Âäõ", meaning: "fuerza", strokes: 6, radicalStrokes: 2 },
    "Âä©": { radical: "Âäõ", meaning: "fuerza", strokes: 7, radicalStrokes: 2 },
    "Âä≥": { radical: "Âäõ", meaning: "fuerza", strokes: 7, radicalStrokes: 2 },
    "Âçá": { radical: "ÂçÅ", meaning: "diez", strokes: 4, radicalStrokes: 2 },
    "Âç´": { radical: "Âç©", meaning: "sello", strokes: 3, radicalStrokes: 2 },
    "ÂéÜ": { radical: "ÂéÇ", meaning: "acantilado", strokes: 4, radicalStrokes: 2 },
    "Âéã": { radical: "ÂéÇ", meaning: "acantilado", strokes: 6, radicalStrokes: 2 },
    "Âèç": { radical: "ÂéÇ", meaning: "acantilado", strokes: 4, radicalStrokes: 2 },
    "Âèó": { radical: "Âèà", meaning: "otra vez", strokes: 8, radicalStrokes: 2 },
    "Âè£": { radical: "Âè£", meaning: "boca", strokes: 3, radicalStrokes: 3 },
    "Âè¨": { radical: "Âè£", meaning: "boca", strokes: 5, radicalStrokes: 3 },
    "Âè≤": { radical: "Âè£", meaning: "boca", strokes: 5, radicalStrokes: 3 },
    "Âêå": { radical: "Âè£", meaning: "boca", strokes: 6, radicalStrokes: 3 },
    "Âê¨": { radical: "Âè£", meaning: "boca", strokes: 7, radicalStrokes: 3 },
    "Âëò": { radical: "Âè£", meaning: "boca", strokes: 7, radicalStrokes: 3 },
    "Âíå": { radical: "Âè£", meaning: "boca", strokes: 8, radicalStrokes: 3 },
    "Âíí": { radical: "Âè£", meaning: "boca", strokes: 8, radicalStrokes: 3 },
    "Âî§": { radical: "Âè£", meaning: "boca", strokes: 10, radicalStrokes: 3 },
    "Âî±": { radical: "Âè£", meaning: "boca", strokes: 11, radicalStrokes: 3 },
    "Âõ¢": { radical: "Âõó", meaning: "recinto", strokes: 6, radicalStrokes: 3 },
    "ÂõΩ": { radical: "Âõó", meaning: "recinto", strokes: 8, radicalStrokes: 3 },
    "Âú£": { radical: "Âúü", meaning: "tierra", strokes: 5, radicalStrokes: 3 },
    "Âú∞": { radical: "Âúü", meaning: "tierra", strokes: 6, radicalStrokes: 3 },
    "Âú∫": { radical: "Âúü", meaning: "tierra", strokes: 6, radicalStrokes: 3 },
    "Âùè": { radical: "Âúü", meaning: "tierra", strokes: 7, radicalStrokes: 3 },
    "ÂûÑ": { radical: "Âúü", meaning: "tierra", strokes: 8, radicalStrokes: 3 },
    "ÂüÉ": { radical: "Âúü", meaning: "tierra", strokes: 10, radicalStrokes: 3 },
    "Â£´": { radical: "Â£´", meaning: "erudito", strokes: 3, radicalStrokes: 3 },
    "Â§ß": { radical: "Â§ß", meaning: "grande", strokes: 3, radicalStrokes: 3 },
    "Â§©": { radical: "Â§ß", meaning: "grande", strokes: 4, radicalStrokes: 3 },
    "Â§™": { radical: "Â§ß", meaning: "grande", strokes: 4, radicalStrokes: 3 },
    "Â§¥": { radical: "Â§ß", meaning: "grande", strokes: 5, radicalStrokes: 3 },
    "Â•¥": { radical: "Â•≥", meaning: "mujer", strokes: 5, radicalStrokes: 3 },
    "Â≠ê": { radical: "Â≠ê", meaning: "hijo", strokes: 3, radicalStrokes: 3 },
    "Â≠©": { radical: "Â≠ê", meaning: "hijo", strokes: 9, radicalStrokes: 3 },
    "ÂØÜ": { radical: "ÂÆÄ", meaning: "techo", strokes: 11, radicalStrokes: 3 },
    "Â∞Ü": { radical: "ÂØ∏", meaning: "pulgada", strokes: 9, radicalStrokes: 3 },
    "Â±Ö": { radical: "Â∞∏", meaning: "cad√°ver", strokes: 8, radicalStrokes: 3 },
    "Â±±": { radical: "Â±±", meaning: "monta√±a", strokes: 3, radicalStrokes: 3 },
    "Â∏Ü": { radical: "Â∑æ", meaning: "pa√±o", strokes: 6, radicalStrokes: 3 },
    "Â∏≠": { radical: "Â∑æ", meaning: "pa√±o", strokes: 10, radicalStrokes: 3 },
    "Âπª": { radical: "Âπ∫", meaning: "peque√±o", strokes: 4, radicalStrokes: 3 },
    "Â∫ú": { radical: "Âπø", meaning: "edificio", strokes: 8, radicalStrokes: 3 },
    "Âº∫": { radical: "Âºì", meaning: "arco", strokes: 12, radicalStrokes: 3 },
    "ÂæÖ": { radical: "ÂΩ≥", meaning: "paso", strokes: 9, radicalStrokes: 3 },
    "Âæ°": { radical: "ÂΩ≥", meaning: "paso", strokes: 12, radicalStrokes: 3 },
    "Âøó": { radical: "ÂøÉ", meaning: "coraz√≥n", strokes: 7, radicalStrokes: 4 },
    "ÊÄß": { radical: "ÂøÉ", meaning: "coraz√≥n", strokes: 8, radicalStrokes: 4 },
    "ÊÄª": { radical: "ÂøÉ", meaning: "coraz√≥n", strokes: 9, radicalStrokes: 4 },
    "ÊÅí": { radical: "ÂøÉ", meaning: "coraz√≥n", strokes: 9, radicalStrokes: 4 },
    "ÊÉ≥": { radical: "ÂøÉ", meaning: "coraz√≥n", strokes: 13, radicalStrokes: 4 },
    "ÊÑö": { radical: "ÂøÉ", meaning: "coraz√≥n", strokes: 13, radicalStrokes: 4 },
    "Êàò": { radical: "Êàà", meaning: "lanza", strokes: 9, radicalStrokes: 4 },
    "Êäó": { radical: "Êâã", meaning: "mano", strokes: 7, radicalStrokes: 4 },
    "Êã≥": { radical: "Êâã", meaning: "mano", strokes: 10, radicalStrokes: 4 },
    "Êçç": { radical: "Êâã", meaning: "mano", strokes: 10, radicalStrokes: 4 },
    "Êëá": { radical: "Êâã", meaning: "mano", strokes: 13, radicalStrokes: 4 },
    "Êíº": { radical: "Êâã", meaning: "mano", strokes: 16, radicalStrokes: 4 },
    "Êîæ": { radical: "Êî¥", meaning: "golpear", strokes: 8, radicalStrokes: 4 },
    "Êîø": { radical: "Êî¥", meaning: "golpear", strokes: 9, radicalStrokes: 4 },
    "Êïå": { radical: "Êî¥", meaning: "golpear", strokes: 10, radicalStrokes: 4 },
    "Êïë": { radical: "Êî¥", meaning: "golpear", strokes: 11, radicalStrokes: 4 },
    "Êï£": { radical: "Êî¥", meaning: "golpear", strokes: 12, radicalStrokes: 4 },
    "Êñó": { radical: "Êñó", meaning: "lucha", strokes: 4, radicalStrokes: 4 },
    "ÊñØ": { radical: "Êñ§", meaning: "hacha", strokes: 12, radicalStrokes: 4 },
    "Êñπ": { radical: "Êñπ", meaning: "cuadrado", strokes: 4, radicalStrokes: 4 },
    "Êó†": { radical: "Êó†", meaning: "no tener", strokes: 4, radicalStrokes: 4 },
    "Êòé": { radical: "Êó•", meaning: "sol", strokes: 8, radicalStrokes: 4 },
    "Êòü": { radical: "Êó•", meaning: "sol", strokes: 9, radicalStrokes: 4 },
    "ÊòØ": { radical: "Êó•", meaning: "sol", strokes: 9, radicalStrokes: 4 },
    "Êö¥": { radical: "Êó•", meaning: "sol", strokes: 15, radicalStrokes: 4 },
    "Êúâ": { radical: "Êúà", meaning: "luna", strokes: 6, radicalStrokes: 4 },
    "ÊùÉ": { radical: "Êú®", meaning: "√°rbol", strokes: 6, radicalStrokes: 4 },
    "Êù•": { radical: "Êú®", meaning: "√°rbol", strokes: 7, radicalStrokes: 4 },
    "Ê≠ª": { radical: "Ê≠π", meaning: "malo", strokes: 6, radicalStrokes: 4 },
    "Ê∞ë": { radical: "Ê∞è", meaning: "clan", strokes: 5, radicalStrokes: 4 },
    "Ê∞¥": { radical: "Ê∞¥", meaning: "agua", strokes: 4, radicalStrokes: 4 },
    "Ê∞∏": { radical: "Ê∞¥", meaning: "agua", strokes: 5, radicalStrokes: 4 },
    "Ê±ó": { radical: "Ê∞¥", meaning: "agua", strokes: 6, radicalStrokes: 4 },
    "Ê≤ü": { radical: "Ê∞¥", meaning: "agua", strokes: 7, radicalStrokes: 4 },
    "Ê≤°": { radical: "Ê∞¥", meaning: "agua", strokes: 7, radicalStrokes: 4 },
    "Ê≤∏": { radical: "Ê∞¥", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "Ê≤ª": { radical: "Ê∞¥", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "Ê≥ï": { radical: "Ê∞¥", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "Ê≥¢": { radical: "Ê∞¥", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "Êµá": { radical: "Ê∞¥", meaning: "agua", strokes: 9, radicalStrokes: 4 },
    "Êµ™": { radical: "Ê∞¥", meaning: "agua", strokes: 10, radicalStrokes: 4 },
    "Ê∂≤": { radical: "Ê∞¥", meaning: "agua", strokes: 11, radicalStrokes: 4 },
    "Ê∏Ø": { radical: "Ê∞¥", meaning: "agua", strokes: 12, radicalStrokes: 4 },
    "Ê∏∏": { radical: "Ê∞¥", meaning: "agua", strokes: 12, radicalStrokes: 4 },
    "ÁÅå": { radical: "Ê∞¥", meaning: "agua", strokes: 21, radicalStrokes: 4 },
    "ÁÅ≠": { radical: "ÁÅ´", meaning: "fuego", strokes: 5, radicalStrokes: 4 },
    "ÁÑ∂": { radical: "ÁÅ´", meaning: "fuego", strokes: 12, radicalStrokes: 4 },
    "ÁäÅ": { radical: "Áâõ", meaning: "buey", strokes: 11, radicalStrokes: 4 },
    "Áäπ": { radical: "Áä¨", meaning: "perro", strokes: 12, radicalStrokes: 4 },
    "Áé∞": { radical: "Áéâ", meaning: "jade", strokes: 8, radicalStrokes: 5 },
    "ÁêÜ": { radical: "Áéâ", meaning: "jade", strokes: 11, radicalStrokes: 5 },
    "Áïå": { radical: "Áî∞", meaning: "campo", strokes: 9, radicalStrokes: 5 },
    "Áóõ": { radical: "Áñí", meaning: "enfermedad", strokes: 12, radicalStrokes: 5 },
    "ÁöÑ": { radical: "ÁôΩ", meaning: "blanco", strokes: 8, radicalStrokes: 5 },
    "Áõó": { radical: "Áöø", meaning: "recipiente", strokes: 11, radicalStrokes: 5 },
    "Áõü": { radical: "Áöø", meaning: "recipiente", strokes: 13, radicalStrokes: 5 },
    "Á†¥": { radical: "Áü≥", meaning: "piedra", strokes: 10, radicalStrokes: 5 },
    "Á§æ": { radical: "Á§∫", meaning: "sagrado", strokes: 7, radicalStrokes: 5 },
    "Á•ñ": { radical: "Á§∫", meaning: "sagrado", strokes: 9, radicalStrokes: 5 },
    "Á•û": { radical: "Á§∫", meaning: "sagrado", strokes: 9, radicalStrokes: 5 },
    "ÁßÅ": { radical: "Á¶æ", meaning: "grano", strokes: 7, radicalStrokes: 5 },
    "Áßò": { radical: "Á¶æ", meaning: "grano", strokes: 10, radicalStrokes: 5 },
    "Á©∫": { radical: "Á©¥", meaning: "cueva", strokes: 8, radicalStrokes: 5 },
    "Á™É": { radical: "Á©¥", meaning: "cueva", strokes: 9, radicalStrokes: 5 },
    "Á´†": { radical: "Á´ã", meaning: "estar de pie", strokes: 11, radicalStrokes: 5 },
    "Á¨¨": { radical: "Á´π", meaning: "bamb√∫", strokes: 11, radicalStrokes: 6 },
    "Á≠â": { radical: "Á´π", meaning: "bamb√∫", strokes: 12, radicalStrokes: 6 },
    "ÁÆ°": { radical: "Á´π", meaning: "bamb√∫", strokes: 14, radicalStrokes: 6 },
    "ÁØá": { radical: "Á´π", meaning: "bamb√∫", strokes: 15, radicalStrokes: 6 },
    "Á∫ß": { radical: "Á≥∏", meaning: "seda", strokes: 6, radicalStrokes: 6 },
    "Á∫ø": { radical: "Á≥∏", meaning: "seda", strokes: 8, radicalStrokes: 6 },
    "Áªì": { radical: "Á≥∏", meaning: "seda", strokes: 9, radicalStrokes: 6 },
    "Áª¥": { radical: "Á≥∏", meaning: "seda", strokes: 11, radicalStrokes: 6 },
    "ÁΩ¢": { radical: "ÁΩí", meaning: "red", strokes: 10, radicalStrokes: 5 },
    "ËÄÖ": { radical: "ËÄÖ", meaning: "persona", strokes: 8, radicalStrokes: 8 },
    "ËÅî": { radical: "ËÄ≥", meaning: "oreja", strokes: 12, radicalStrokes: 6 },
    "ËÉú": { radical: "Êúà", meaning: "carne", strokes: 9, radicalStrokes: 4 },
    "ËÑâ": { radical: "Êúà", meaning: "carne", strokes: 9, radicalStrokes: 4 },
    "ËÖæ": { radical: "Êúà", meaning: "carne", strokes: 13, radicalStrokes: 4 },
    "Ëàπ": { radical: "Ëàü", meaning: "barco", strokes: 11, radicalStrokes: 6 },
    "Ëâ≤": { radical: "Ëâ≤", meaning: "color", strokes: 6, radicalStrokes: 6 },
    "Ëãè": { radical: "Ëâπ", meaning: "hierba", strokes: 7, radicalStrokes: 3 },
    "Ëã¶": { radical: "Ëâπ", meaning: "hierba", strokes: 8, radicalStrokes: 3 },
    "ËôΩ": { radical: "Ëô´", meaning: "insecto", strokes: 9, radicalStrokes: 6 },
    "Ë†¢": { radical: "Ëô´", meaning: "insecto", strokes: 21, radicalStrokes: 6 },
    "Ë°Ä": { radical: "Ë°Ä", meaning: "sangre", strokes: 6, radicalStrokes: 6 },
    "Ë°å": { radical: "Ë°å", meaning: "caminar", strokes: 6, radicalStrokes: 6 },
    "Ë¢ñ": { radical: "Ë°£", meaning: "ropa", strokes: 10, radicalStrokes: 6 },
    "Ë¢´": { radical: "Ë°£", meaning: "ropa", strokes: 10, radicalStrokes: 6 },
    "Ë•ø": { radical: "Ë•ø", meaning: "oeste", strokes: 6, radicalStrokes: 6 },
    "ËßÅ": { radical: "Ë¶ã", meaning: "ver", strokes: 4, radicalStrokes: 7 },
    "Ëß£": { radical: "Ëßí", meaning: "cuerno", strokes: 13, radicalStrokes: 7 },
    "ËØÖ": { radical: "Ë®Ä", meaning: "palabra", strokes: 8, radicalStrokes: 7 },
    "ËØ≠": { radical: "Ë®Ä", meaning: "palabra", strokes: 9, radicalStrokes: 7 },
    "Ëµ∑": { radical: "Ëµ∞", meaning: "caminar", strokes: 10, radicalStrokes: 7 },
    "Ëøê": { radical: "Ëæ∂", meaning: "camino", strokes: 7, radicalStrokes: 3 },
    "Ëøõ": { radical: "Ëæ∂", meaning: "camino", strokes: 7, radicalStrokes: 3 },
    "Ëøú": { radical: "Ëæ∂", meaning: "camino", strokes: 7, radicalStrokes: 3 },
    "Ëø´": { radical: "Ëæ∂", meaning: "camino", strokes: 8, radicalStrokes: 3 },
    "ÈÉΩ": { radical: "ÈÇë", meaning: "ciudad", strokes: 10, radicalStrokes: 7 },
    "Èìæ": { radical: "Èáë", meaning: "metal", strokes: 11, radicalStrokes: 8 },
    "ÈîÅ": { radical: "Èáë", meaning: "metal", strokes: 12, radicalStrokes: 8 },
    "Èòü": { radical: "Èòú", meaning: "mont√≠culo", strokes: 4, radicalStrokes: 8 },
    "Èò≤": { radical: "Èòú", meaning: "mont√≠culo", strokes: 6, radicalStrokes: 8 },
    "Èò≥": { radical: "Èòú", meaning: "mont√≠culo", strokes: 6, radicalStrokes: 8 },
    "Èò∂": { radical: "Èòú", meaning: "mont√≠culo", strokes: 8, radicalStrokes: 8 },
    "ÈôÖ": { radical: "Èòú", meaning: "mont√≠culo", strokes: 8, radicalStrokes: 8 },
    "Èö∂": { radical: "Èö∂", meaning: "sirviente", strokes: 8, radicalStrokes: 8 },
    "Èõá": { radical: "Èöπ", meaning: "p√°jaro", strokes: 12, radicalStrokes: 8 },
    "È¢Ü": { radical: "È†Å", meaning: "cabeza", strokes: 11, radicalStrokes: 9 },
    "È£é": { radical: "È¢®", meaning: "viento", strokes: 4, radicalStrokes: 9 },
    "È••": { radical: "È£ü", meaning: "comida", strokes: 6, radicalStrokes: 9 },
    "È•ø": { radical: "È£ü", meaning: "comida", strokes: 10, radicalStrokes: 9 },
    "Èªé": { radical: "Èªç", meaning: "mijo", strokes: 15, radicalStrokes: 12 },
    "Èªë": { radical: "Èªë", meaning: "negro", strokes: 12, radicalStrokes: 12 }
  };

  // Funci√≥n para generar an√°lisis de radicales usando base de datos Kangxi real
  async function loadRadicalAnalysis() {
    const containers = document.querySelectorAll('.radical-analyzer-container');
    if (containers.length === 0) return;
    
    containers.forEach(async (container) => {
      const character = container.dataset.character;
      
      // Buscar en la base de datos Kangxi real
      const kangxiData = kangxiRadicals[character];
      
      if (kangxiData) {
        // Intentar obtener trazos exactos de MDBG via Unicode
        const unicodeDecimal = character.codePointAt(0);
        let strokeCount = kangxiData.strokes;
        
        // Intentar obtener informaci√≥n m√°s precisa (simulando consulta a MDBG)
        try {
          // En una implementaci√≥n real, aqu√≠ consultar√≠as la API de MDBG
          // Por ahora usamos la base de datos local
          strokeCount = kangxiData.strokes;
        } catch (error) {
          console.log(`‚ÑπÔ∏è Usando trazos de base de datos local para ${character}`);
        }
        
        const characterData = {
          character: character,
          radical: kangxiData.radical,
          radicalMeaning: kangxiData.meaning,
          strokes: strokeCount,
          radicalStrokes: kangxiData.radicalStrokes,
          isRevolutionary: isRevolutionaryCharacter(character),
          source: "Base de datos Kangxi"
        };
        
        const analysisHTML = generateKangxiRadicalHTML(characterData);
        container.innerHTML = analysisHTML;
        console.log(`‚úÖ Radical Kangxi cargado para: ${character} - ${kangxiData.radical} (${kangxiData.meaning})`);
      } else {
        container.innerHTML = `<span style="color: #6c757d;">üìù An√°lisis de ${character} en desarrollo</span>`;
        console.log(`‚ÑπÔ∏è No se encontr√≥ radical Kangxi para: ${character}`);
      }
    });
  }
  
  // Funci√≥n para determinar si un car√°cter es revolucionario
  function isRevolutionaryCharacter(character) {
    const revolutionaryChars = [
      "Âèç", "Êäó", "Èù©", "ÂëΩ", "Ê∞ë", "ÂõΩ", "ÂÖö", "Êîø", "ÊùÉ", "Êñó", "‰∫â", "Êàò",
      "ËÉú", "Âà©", "Âäõ", "Â∑•", "ÂÜú", "Âúü", "Âú∞", "‰∫∫", "‰∏ª", "‰πâ", "Ëá™", "Áî±",
      "Âõ¢", "Áªì", "Ëß£", "Êîæ", "ËÅî", "Áõü", "Á§æ", "‰ºö", "Âä≥", "‰Ωú", "Ëµ∑", "Êù•"
    ];
    return revolutionaryChars.includes(character);
  }

  // Funci√≥n para generar HTML de radical usando base de datos Kangxi
  function generateKangxiRadicalHTML(data) {
    const isRevolutionary = data.isRevolutionary;
    
    let html = `
      <div class="radical-content">
        <div class="radical-header">
          <div class="radical-display">${data.character}</div>
          ${isRevolutionary ? '<span class="revolutionary-badge">üö© Revolucionario</span>' : ''}
        </div>
    `;
    
    // Informaci√≥n del radical Kangxi
    html += `
      <div style="margin-bottom: 0.5rem;">
        <strong>Radical Kangxi:</strong> <span class="radical-display" style="font-size: 1.2rem;">${data.radical}</span>
      </div>
      <div class="radical-meaning">
        ${data.radicalMeaning}
      </div>
    `;
    
    // Informaci√≥n de trazos precisa
    html += `
      <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
        üìè <strong>Trazos del car√°cter:</strong> ${data.strokes}
      </div>
      <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #666;">
        üéØ <strong>Trazos del radical:</strong> ${data.radicalStrokes}
      </div>
    `;
    
    // Fuente de datos
    html += `
      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #999;">
        üìñ Fuente: ${data.source}
      </div>
    `;
    
    // Contexto revolucionario
    if (isRevolutionary) {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #dc3545; font-weight: 500;">
          üö© Car√°cter clave en vocabulario revolucionario
        </div>
      `;
    }
    
    html += `</div>`;
    return html;
  }

  // Funci√≥n para generar HTML de radical usando datos del diccionario
  function generateRadicalHTMLFromDictionary(data) {
    const isRevolutionary = data.isRevolutionary;
    
    // Extraer radical limpio (sin par√©ntesis)
    let radicalChar = data.radical;
    let radicalMeaning = "";
    
    const radicalMatch = data.radical.match(/^([^\s(]+)\s*\(([^)]+)\)/);
    if (radicalMatch) {
      radicalChar = radicalMatch[1];
      radicalMeaning = radicalMatch[2];
    }
    
    let html = `
      <div class="radical-content">
        <div class="radical-header">
          <div class="radical-display">${data.character}</div>
          ${isRevolutionary ? '<span class="revolutionary-badge">üö© Revolucionario</span>' : ''}
        </div>
    `;
    
    // Informaci√≥n del radical
    html += `
      <div style="margin-bottom: 0.5rem;">
        <strong>Radical:</strong> <span class="radical-display" style="font-size: 1.2rem;">${radicalChar}</span>
      </div>
      <div class="radical-meaning">
        ${radicalMeaning || 'Significado no disponible'}
      </div>
    `;
    
    // Informaci√≥n adicional
    if (data.strokes && data.strokes !== "?") {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
          üìè <strong>Trazos:</strong> ${data.strokes} <small style="color: #999;">(aproximado)</small>
        </div>
      `;
    }
    
    if (data.structure && data.structure !== "desconocida") {
      html += `
        <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #666;">
          üèóÔ∏è <strong>Estructura:</strong> ${data.structure}
        </div>
      `;
    }
    
    // Significado del car√°cter en espa√±ol
    if (data.meaning) {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6c757d; font-style: italic;">
          üí° ${data.meaning}
        </div>
      `;
    }
    
    // Contexto revolucionario
    if (isRevolutionary) {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #dc3545; font-weight: 500;">
          üö© Car√°cter clave en vocabulario revolucionario
        </div>
      `;
    }
    
    html += `</div>`;
    return html;
  }

  function generateRadicalHTML(analysis) {
    const isRevolutionary = analysis.revolutionaryRelevance;
    
    let html = `
      <div class="radical-content">
        <div class="radical-header">
          <div class="radical-display">${analysis.character}</div>
          ${isRevolutionary ? '<span class="revolutionary-badge">üö© Revolucionario</span>' : ''}
        </div>
    `;
    
    // Informaci√≥n del radical
    if (analysis.radicalData && analysis.radicalData.meaning) {
      html += `
        <div style="margin-bottom: 0.5rem;">
          <strong>Radical:</strong> <span class="radical-display" style="font-size: 1.2rem;">${analysis.radical}</span>
        </div>
        <div class="radical-meaning">
          ${analysis.radicalData.meaning.es}
        </div>
      `;
      
      if (analysis.radicalData.category) {
        html += `<div class="radical-category">${analysis.radicalData.category}</div>`;
      }
    } else {
      html += `
        <div style="margin-bottom: 0.5rem;">
          <strong>Radical:</strong> <span class="radical-display" style="font-size: 1.2rem;">${analysis.radical}</span>
        </div>
        <div class="radical-meaning">An√°lisis en desarrollo</div>
      `;
    }
    
    // Etimolog√≠a breve si est√° disponible
    if (analysis.etymology && analysis.etymology.es) {
      const shortEtymology = analysis.etymology.es.length > 80 
        ? analysis.etymology.es.substring(0, 80) + '...' 
        : analysis.etymology.es;
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6c757d; font-style: italic;">
          üí° ${shortEtymology}
        </div>
      `;
    }
    
    html += `</div>`;
    return html;
  }

  // Funcionalidad de radicales movida a p√°gina independiente

  window.retryLoad = init;
  
  init();
});
</script>