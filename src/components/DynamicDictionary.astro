---
export interface Props {
  language: string;
  initialWords?: number;
  availableLangs: Record<string, string>;
  baseUrl: string;
}

const { language, initialWords = 20, availableLangs, baseUrl } = Astro.props;
---

<div class="dynamic-dictionary" data-language={language}>
  <!-- Skeleton loader inicial -->
  <div class="dictionary-skeleton" id="dictionary-skeleton">
    <div class="skeleton-header">
      <div class="skeleton-text skeleton-title"></div>
      <div class="skeleton-text skeleton-subtitle"></div>
    </div>
    <div class="skeleton-search">
      <div class="skeleton-input"></div>
    </div>
    <div class="skeleton-grid">
      {Array.from({length: initialWords}, (_, i) => (
        <div class="skeleton-card" key={i}>
          <div class="skeleton-text skeleton-word"></div>
          <div class="skeleton-text skeleton-translation"></div>
          <div class="skeleton-text skeleton-source"></div>
        </div>
      ))}
    </div>
  </div>
  
  <!-- Contenido real (se carga dinámicamente) -->
  <div class="dictionary-content" id="dictionary-content" style="display: none;">
    <!-- El contenido se insertará aquí vía JavaScript -->
  </div>
  
  <!-- Indicador de carga -->
  <div class="loading-indicator" id="loading-indicator" style="display: none;">
    <div class="spinner"></div>
    <p>Cargando vocabulario...</p>
  </div>
  
  <!-- Error handler -->
  <div class="error-message" id="error-message" style="display: none;">
    <div class="error-icon">⚠️</div>
    <h3>Error cargando diccionario</h3>
    <p>No se pudo cargar el vocabulario. <button onclick="retryLoad()">Reintentar</button></p>
  </div>

  <!-- Modal para detalles de la palabra -->
  <div id="word-modal" class="modal" style="display: none !important;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>
</div>

<style is:global>
  /* Estilos base */
  .dynamic-dictionary { width: 100%; position: relative; }
  .dictionary-skeleton { animation: fadeIn 0.5s ease-in-out; }
  .skeleton-header { text-align: center; margin-bottom: var(--space-2xl); }
  .skeleton-text { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-md); }
  .skeleton-title { height: 3rem; width: 300px; margin: 0 auto var(--space-lg); }
  .skeleton-subtitle { height: 1.5rem; width: 200px; margin: 0 auto; }
  .skeleton-search { max-width: 500px; margin: 0 auto var(--space-2xl); }
  .skeleton-input { height: 3rem; width: 100%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-lg); }
  .skeleton-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--space-lg); }
  .skeleton-card { background: var(--color-paper); padding: var(--space-xl); border-radius: var(--radius-lg); border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); }
  .skeleton-word { height: 2rem; width: 60%; margin-bottom: var(--space-lg); }
  .skeleton-translation { height: 1rem; width: 80%; margin-bottom: var(--space-md); }
  .skeleton-source { height: 1rem; width: 40%; }
  @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .loading-indicator { text-align: center; padding: var(--space-3xl); display: flex; flex-direction: column; align-items: center; gap: var(--space-lg); }
  .spinner { width: 40px; height: 40px; border: 4px solid var(--color-border-light); border-top: 4px solid var(--color-revolutionary-red); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .error-message { text-align: center; padding: var(--space-3xl); background: var(--color-paper); border: 2px solid var(--color-border); border-radius: var(--radius-lg); color: var(--color-text-secondary); }
  .error-icon { font-size: 3rem; margin-bottom: var(--space-lg); }
  .error-message button { background: var(--color-revolutionary-red); color: white; border: none; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); cursor: pointer; font-weight: 600; margin-top: var(--space-md); }
  .error-message button:hover { background: var(--color-revolutionary-red-dark); }
  .dictionary-content { animation: slideIn 0.5s ease-out; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @media (max-width: 768px) { .skeleton-grid { grid-template-columns: 1fr; } .skeleton-title { width: 250px; } }

  .modal {
    position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.6);
    display: flex; align-items: center; justify-content: center;
  }
  .modal-content {
    background-color: var(--color-background);
    margin: auto; padding: var(--space-2xl);
    border: 1px solid var(--color-border);
    width: 80%; max-width: 700px; border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    position: relative;
  }
  .close-button {
    color: var(--color-text-secondary); float: right; font-size: 2rem; font-weight: bold;
    cursor: pointer;
  }
  .close-button:hover, .close-button:focus { color: var(--color-text-primary); }

  /* Estilos para el contenido dinámico del diccionario */
  .dictionary-header { 
    text-align: center; 
    margin-bottom: var(--space-2xl); 
    padding-bottom: var(--space-lg);
    border-bottom: 2px solid var(--color-revolutionary-red-light);
  }
  .dictionary-header h2 { 
    color: var(--color-revolutionary-red); 
    margin-bottom: var(--space-md); 
    font-size: clamp(1.5rem, 4vw, 2rem);
  }
  .dictionary-header p { 
    color: var(--color-text-secondary); 
    font-size: 1.1rem; 
    font-weight: 500;
  }

  .search-section { 
    margin-bottom: var(--space-2xl); 
  }
  #word-search { 
    width: 100%; 
    max-width: 500px; 
    margin: 0 auto var(--space-lg); 
    display: block;
    padding: var(--space-md) var(--space-lg); 
    border: 2px solid var(--color-border); 
    border-radius: var(--radius-lg); 
    font-size: 1rem;
    font-family: var(--font-primary);
    transition: all 0.2s ease;
    background: var(--color-paper);
  }
  #word-search:focus { 
    outline: none; 
    border-color: var(--color-revolutionary-red); 
    box-shadow: 0 0 0 3px var(--color-revolutionary-red-light);
  }

  .alphabet-filter { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    gap: var(--space-sm); 
    margin-bottom: var(--space-lg);
  }
  .letter-btn { 
    background: var(--color-paper); 
    border: 2px solid var(--color-border); 
    color: var(--color-text-secondary); 
    padding: var(--space-sm) var(--space-md); 
    border-radius: var(--radius-md); 
    cursor: pointer; 
    font-weight: 500;
    font-family: var(--font-primary);
    transition: all 0.2s ease;
    min-width: 45px;
  }
  .letter-btn:hover { 
    background: var(--color-revolutionary-red-light); 
    border-color: var(--color-revolutionary-red); 
    color: var(--color-revolutionary-red-dark);
    transform: translateY(-1px);
  }
  .letter-btn.active { 
    background: var(--color-revolutionary-red); 
    border-color: var(--color-revolutionary-red); 
    color: white; 
    font-weight: 600;
  }

  .dictionary-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
    gap: var(--space-lg); 
  }
  .word-card { 
    background: var(--color-paper); 
    border: 1px solid var(--color-border); 
    border-radius: var(--radius-lg); 
    padding: var(--space-xl); 
    cursor: pointer; 
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
  }
  .word-card:hover { 
    transform: translateY(-2px); 
    box-shadow: var(--shadow-lg); 
    border-color: var(--color-revolutionary-red-light);
  }
  .word-title { 
    color: var(--color-revolutionary-red); 
    margin-bottom: var(--space-md); 
    font-size: 1.4rem;
    font-weight: 700;
  }
  .word-meta { 
    display: flex; 
    flex-direction: column; 
    gap: var(--space-sm); 
  }
  .word-meta span { 
    font-size: 0.9rem; 
    color: var(--color-text-secondary); 
  }
  .meaning { 
    color: var(--color-socialist-gold-dark); 
    font-weight: 600;
  }
  .lessons {
    color: var(--color-text-muted);
  }

  /* Estilos para el modal */
  .pinyin-syllable.tone-1 { color: #f44336; }
  .pinyin-syllable.tone-2 { color: #ff9800; }
  .pinyin-syllable.tone-3 { color: #4caf50; }
  .pinyin-syllable.tone-4 { color: #2196f3; }
  .pinyin-syllable.tone-5 { color: #9e9e9e; }

  .modal-entry {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }
  .modal-entry:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .modal-entry h4 {
    color: var(--color-revolutionary-red);
    margin: var(--space-md) 0 var(--space-sm) 0;
    font-size: 1.1rem;
  }
  .modal-entry ul {
    margin: 0;
    padding-left: var(--space-lg);
  }
  .modal-entry li {
    margin-bottom: var(--space-xs);
    color: var(--color-text-secondary);
  }
  .post-link {
    color: var(--color-revolutionary-red);
    text-decoration: none;
    font-weight: 500;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-revolutionary-red-light);
    border-radius: var(--radius-md);
    display: inline-block;
    margin-top: var(--space-sm);
    transition: all 0.2s ease;
  }
  .post-link:hover {
    background: var(--color-revolutionary-red);
    color: white;
    transform: translateY(-1px);
  }

  /* Estilos responsivos */
  @media (max-width: 768px) {
    .dictionary-grid { 
      grid-template-columns: 1fr; 
    }
    .alphabet-filter {
      gap: var(--space-xs);
    }
    .letter-btn {
      min-width: 40px;
      padding: var(--space-xs) var(--space-sm);
      font-size: 0.9rem;
    }
    #word-search {
      margin: 0 0 var(--space-lg) 0;
    }
  }
</style>

<script define:vars={{ language, availableLangs, baseUrl }}>
document.addEventListener('DOMContentLoaded', async function() {
  const container = document.querySelector('.dynamic-dictionary');
  const skeleton = document.getElementById('dictionary-skeleton');
  const contentEl = document.getElementById('dictionary-content');
  const loading = document.getElementById('loading-indicator');
  const error = document.getElementById('error-message');
  const modal = document.getElementById('word-modal');
  const modalBody = document.getElementById('modal-body');
  const closeModalBtn = document.querySelector('.close-button');

  let dictionaryData = null;
  let allWords = [];

  async function loadDictionaryData() {
    try {
      console.log(` Cargando diccionario dinámico para: ${availableLangs[language]} (${language})`);
      
      // Mostrar loading después de 300ms si no ha cargado
      const loadingTimeout = setTimeout(() => {
        skeleton.style.display = 'none';
        loading.style.display = 'flex';
      }, 300);

      const manifestResponse = await fetch(`${baseUrl}data/internal/v1/dictionary/chunks-manifest.json`);
      if (!manifestResponse.ok) throw new Error('No se pudo cargar el manifest de chunks');
      const manifest = await manifestResponse.json();

      const langManifest = manifest.languages.find(lang => lang.code === language);
      if (!langManifest) throw new Error(`No se encontró manifest para el idioma ${language}`);
      const chunkFile = langManifest.chunksPath.split('/').pop().replace('*', 'lessons-0-12.json');
      if (!chunkFile) throw new Error(`No se encontró chunk para el idioma ${language}`);

      const chunkResponse = await fetch(`${baseUrl}data/internal/v1/dictionary/chunks/${chunkFile}`);
      if (!chunkResponse.ok) throw new Error(`No se pudo cargar el archivo de chunk ${chunkFile}`);
      
      dictionaryData = await chunkResponse.json();
      allWords = Object.entries(dictionaryData.words);

      clearTimeout(loadingTimeout);
      
      console.log(`Diccionario cargado: ${allWords.length} palabras`);
      
      renderDictionary();
      
      skeleton.style.display = 'none';
      loading.style.display = 'none';
      error.style.display = 'none';
      contentEl.style.display = 'block';
      
    } catch (err) {
      console.error('Error cargando diccionario:', err);
      skeleton.style.display = 'none';
      loading.style.display = 'none';
      contentEl.style.display = 'none';
      error.style.display = 'block';
    }
  }
  
  function renderDictionary() {
    if (!dictionaryData) return;
    
    const letters = [...new Set(allWords.map(([word]) => word[0].toUpperCase()))].sort();

    contentEl.innerHTML = `
      <style>
        .dictionary-content .dictionary-header { 
          text-align: center; 
          margin-bottom: var(--space-2xl); 
          padding-bottom: var(--space-lg);
          border-bottom: 2px solid var(--color-revolutionary-red-light);
        }
        .dictionary-content .dictionary-header h2 { 
          color: var(--color-revolutionary-red); 
          margin-bottom: var(--space-md); 
          font-size: clamp(1.5rem, 4vw, 2rem);
        }
        .dictionary-content .dictionary-header p { 
          color: var(--color-text-secondary); 
          font-size: 1.1rem; 
          font-weight: 500;
        }
        .dictionary-content .search-section { 
          margin-bottom: var(--space-2xl); 
        }
        .dictionary-content #word-search { 
          width: 100%; 
          max-width: 500px; 
          margin: 0 auto var(--space-lg); 
          display: block;
          padding: var(--space-md) var(--space-lg); 
          border: 2px solid var(--color-border); 
          border-radius: var(--radius-lg); 
          font-size: 1rem;
          font-family: var(--font-primary);
          transition: all 0.2s ease;
          background: var(--color-paper);
        }
        .dictionary-content #word-search:focus { 
          outline: none; 
          border-color: var(--color-revolutionary-red); 
          box-shadow: 0 0 0 3px var(--color-revolutionary-red-light);
        }
        .dictionary-content .alphabet-filter { 
          display: flex; 
          flex-wrap: wrap; 
          justify-content: center; 
          gap: var(--space-sm); 
          margin-bottom: var(--space-lg);
        }
        .dictionary-content .letter-btn { 
          background: var(--color-paper); 
          border: 2px solid var(--color-border); 
          color: var(--color-text-secondary); 
          padding: var(--space-sm) var(--space-md); 
          border-radius: var(--radius-md); 
          cursor: pointer; 
          font-weight: 500;
          font-family: var(--font-primary);
          transition: all 0.2s ease;
          min-width: 45px;
        }
        .dictionary-content .letter-btn:hover { 
          background: var(--color-revolutionary-red-light); 
          border-color: var(--color-revolutionary-red); 
          color: var(--color-revolutionary-red-dark);
          transform: translateY(-1px);
        }
        .dictionary-content .letter-btn.active { 
          background: var(--color-revolutionary-red); 
          border-color: var(--color-revolutionary-red); 
          color: white; 
          font-weight: 600;
        }
        .dictionary-content .dictionary-grid { 
          display: grid; 
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
          gap: var(--space-lg); 
        }
        .dictionary-content .word-card { 
          background: var(--color-paper); 
          border: 1px solid var(--color-border); 
          border-radius: var(--radius-lg); 
          padding: var(--space-xl); 
          cursor: pointer; 
          transition: all 0.2s ease;
          box-shadow: var(--shadow-sm);
        }
        .dictionary-content .word-card:hover { 
          transform: translateY(-2px); 
          box-shadow: var(--shadow-lg); 
          border-color: var(--color-revolutionary-red-light);
        }
        .dictionary-content .word-title { 
          color: var(--color-revolutionary-red); 
          margin-bottom: var(--space-md); 
          font-size: 1.4rem;
          font-weight: 700;
        }
        .dictionary-content .word-meta { 
          display: flex; 
          flex-direction: column; 
          gap: var(--space-sm); 
        }
        .dictionary-content .word-meta span { 
          font-size: 0.9rem; 
          color: var(--color-text-secondary); 
        }
        .dictionary-content .meaning { 
          color: var(--color-socialist-gold-dark); 
          font-weight: 600;
        }
        .dictionary-content .lessons {
          color: var(--color-text-muted);
        }
        @media (max-width: 768px) {
          .dictionary-content .dictionary-grid { 
            grid-template-columns: 1fr; 
          }
          .dictionary-content .alphabet-filter {
            gap: var(--space-xs);
          }
          .dictionary-content .letter-btn {
            min-width: 40px;
            padding: var(--space-xs) var(--space-sm);
            font-size: 0.9rem;
          }
          .dictionary-content #word-search {
            margin: 0 0 var(--space-lg) 0;
          }
        }
        
        /* Estilos para el modal */
        .modal {
          position: fixed !important;
          z-index: 1000 !important;
          left: 0 !important;
          top: 0 !important;
          width: 100% !important;
          height: 100% !important;
          overflow: auto !important;
          background-color: rgba(0,0,0,0.7) !important;
          align-items: center !important;
          justify-content: center !important;
        }
        .modal[style*="display: none"] {
          display: none !important;
        }
        .modal[style*="display: flex"] {
          display: flex !important;
        }
        .modal-content {
          background-color: var(--color-paper) !important;
          margin: auto !important;
          padding: var(--space-2xl) !important;
          border: 1px solid var(--color-border) !important;
          width: 90% !important;
          max-width: 800px !important;
          border-radius: var(--radius-lg) !important;
          box-shadow: var(--shadow-xl) !important;
          position: relative !important;
          max-height: 90vh !important;
          overflow-y: auto !important;
        }
        .close-button {
          color: var(--color-text-secondary) !important;
          float: right !important;
          font-size: 2rem !important;
          font-weight: bold !important;
          cursor: pointer !important;
          line-height: 1 !important;
          padding: var(--space-xs) !important;
        }
        .close-button:hover, .close-button:focus {
          color: var(--color-revolutionary-red) !important;
        }
        
        /* Estilos para la sección de trazos chinos */
        .stroke-section {
          margin-bottom: 1.5rem !important;
          padding: 1rem !important;
          background: #f8f9fa !important;
          border-radius: 8px !important;
          border: 1px solid #e9ecef !important;
        }
        .stroke-section h4 {
          margin-bottom: 1rem !important;
          color: var(--color-revolutionary-red) !important;
          font-size: 1.2rem !important;
          text-align: center !important;
        }
        .stroke-gifs {
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 0.75rem !important;
          justify-content: center !important;
        }
        .stroke-gif {
          text-align: center !important;
          transition: transform 0.2s ease !important;
        }
        .stroke-gif:hover {
          transform: scale(1.05) !important;
        }
        .stroke-gif img {
          width: 100px !important;
          height: 100px !important;
          border: 2px solid #ddd !important;
          border-radius: 6px !important;
          background: white !important;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
          transition: border-color 0.2s ease !important;
        }
        .stroke-gif img:hover {
          border-color: var(--color-revolutionary-red) !important;
        }
        .stroke-gif div {
          font-size: 1.2rem !important;
          color: #495057 !important;
          margin-top: 0.5rem !important;
          font-weight: 600 !important;
          font-family: 'SimSun', '宋体', serif !important;
        }
        .character-pinyin {
          font-size: 1.1rem !important;
          margin-top: 0.5rem !important;
          font-weight: 600 !important;
          font-family: 'Courier New', monospace !important;
        }
        /* Los colores de tonos tienen prioridad sobre character-pinyin */
        .character-pinyin.pinyin-syllable.tone-1 { color: #f44336 !important; }
        .character-pinyin.pinyin-syllable.tone-2 { color: #ff9800 !important; }
        .character-pinyin.pinyin-syllable.tone-3 { color: #4caf50 !important; }
        .character-pinyin.pinyin-syllable.tone-4 { color: #2196f3 !important; }
        .character-pinyin.pinyin-syllable.tone-5 { color: #9e9e9e !important; }
        
        /* Estilos para la sección de caracteres grandes */
        .chinese-large-display {
          text-align: center !important;
          margin-top: 1rem !important;
          padding: 0.75rem !important;
          background: white !important;
          border-radius: 6px !important;
          border: 1px solid #e9ecef !important;
        }
        .chinese-large-text {
          font-size: 2.5rem !important;
          font-weight: 300 !important;
          color: #2c3e50 !important;
          letter-spacing: 0.5rem !important;
          font-family: 'SimSun', '宋体', serif !important;
          line-height: 1.2 !important;
        }
        .stroke-attribution {
          margin-top: 0.75rem !important;
          text-align: center !important;
          color: #6c757d !important;
          font-size: 0.75rem !important;
        }
        .stroke-attribution a {
          color: #0066cc !important;
          text-decoration: none !important;
        }
        .stroke-attribution a:hover {
          text-decoration: underline !important;
        }
        .radical-analysis-section {
          margin-top: 1.5rem !important;
          padding-top: 1rem !important;
          border-top: 2px solid #e9ecef !important;
        }
        .radical-analysis-section h4 {
          color: #007bff !important;
          margin-bottom: 1rem !important;
          font-size: 1.1rem !important;
        }
        .radical-analyzer-container {
          background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
          border-radius: 8px !important;
          padding: 1rem !important;
          margin: 0.75rem 0 !important;
          border: 1px solid #dee2e6 !important;
        }
        .radical-loading-mini {
          display: flex !important;
          align-items: center !important;
          gap: 0.5rem !important;
          color: #6c757d !important;
          font-size: 0.9rem !important;
        }
        .loading-mini {
          width: 16px !important;
          height: 16px !important;
          border: 2px solid #e9ecef !important;
          border-top: 2px solid #007bff !important;
          border-radius: 50% !important;
          animation: spin-mini 1s linear infinite !important;
        }
        @keyframes spin-mini {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .radical-content {
          background: white !important;
          border-radius: 6px !important;
          padding: 0.75rem !important;
          border: 1px solid #dee2e6 !important;
        }
        .radical-header {
          text-align: center !important;
          margin-bottom: 1rem !important;
          padding-bottom: 0.5rem !important;
          border-bottom: 1px solid #e9ecef !important;
        }
        .radical-display {
          font-size: 1.5rem !important;
          font-family: 'SimSun', '宋体', serif !important;
          color: #007bff !important;
          margin: 0.25rem 0 !important;
        }
        .radical-meaning {
          color: #6c757d !important;
          font-style: italic !important;
          font-size: 0.85rem !important;
        }
        .radical-category {
          display: inline-block !important;
          background: #007bff !important;
          color: white !important;
          padding: 0.2rem 0.4rem !important;
          border-radius: 3px !important;
          font-size: 0.7rem !important;
          margin-top: 0.25rem !important;
        }
        .revolutionary-badge {
          display: inline-block !important;
          background: #dc3545 !important;
          color: white !important;
          padding: 0.2rem 0.4rem !important;
          border-radius: 3px !important;
          font-size: 0.7rem !important;
          margin-left: 0.5rem !important;
        }
        
        /* Responsive para móviles */
        @media (max-width: 768px) {
          .stroke-gif img {
            width: 80px !important;
            height: 80px !important;
          }
          .stroke-gifs {
            gap: 0.5rem !important;
          }
          .chinese-large-text {
            font-size: 2rem !important;
            letter-spacing: 0.3rem !important;
          }
        }
        @media (max-width: 480px) {
          .stroke-gif img {
            width: 70px !important;
            height: 70px !important;
          }
          .stroke-section {
            padding: 0.75rem !important;
          }
          .chinese-large-text {
            font-size: 1.8rem !important;
            letter-spacing: 0.2rem !important;
          }
        }
        .modal-entry {
          margin-bottom: var(--space-lg) !important;
          padding-bottom: var(--space-lg) !important;
          border-bottom: 1px solid var(--color-border) !important;
        }
        .modal-entry:last-child {
          border-bottom: none !important;
          margin-bottom: 0 !important;
          padding-bottom: 0 !important;
        }
        .modal-entry h4 {
          color: var(--color-revolutionary-red) !important;
          margin: var(--space-md) 0 var(--space-sm) 0 !important;
          font-size: 1.1rem !important;
        }
        .modal-entry ul {
          margin: 0 !important;
          padding-left: var(--space-lg) !important;
        }
        .modal-entry li {
          margin-bottom: var(--space-xs) !important;
          color: var(--color-text-secondary) !important;
        }
        .post-link {
          color: var(--color-revolutionary-red) !important;
          text-decoration: none !important;
          font-weight: 500 !important;
          padding: var(--space-sm) var(--space-md) !important;
          border: 1px solid var(--color-revolutionary-red-light) !important;
          border-radius: var(--radius-md) !important;
          display: inline-block !important;
          margin-top: var(--space-sm) !important;
          transition: all 0.2s ease !important;
        }
        .post-link:hover {
          background: var(--color-revolutionary-red) !important;
          color: white !important;
          transform: translateY(-1px) !important;
        }
        #modal-body h2 {
          color: var(--color-revolutionary-red) !important;
          margin-bottom: var(--space-lg) !important;
          font-size: 1.8rem !important;
          font-weight: 700 !important;
        }
        #modal-body p {
          color: var(--color-text-primary) !important;
          line-height: 1.6 !important;
          margin-bottom: var(--space-md) !important;
        }
        #modal-body strong {
          color: var(--color-text-primary) !important;
          font-weight: 600 !important;
        }
      </style>
      <div class="dictionary-header">
        <h2>Vocabulario de ${availableLangs[language] || language}</h2>
        <p>${allWords.length} palabras encontradas</p>
      </div>
      <div class="search-section">
        <input type="text" id="word-search" placeholder="Buscar palabras..." />
        <div class="alphabet-filter" id="alphabet-filter">
          <button class="letter-btn active" data-letter="all">Todos</button>
          ${letters.map(letter => 
            `<button class="letter-btn" data-letter="${letter}">${letter}</button>`
          ).join('')}
        </div>
      </div>
      
      <!-- Búsqueda por radicales para idiomas chinos -->
      ${language === 'zh' || language === 'zh-pinyin' ? `
        <div class="radical-search-section" id="radical-search-section" style="margin-bottom: var(--space-2xl);">
          <div class="radical-search-toggle" style="text-align: center; margin-bottom: var(--space-lg);">
            <button id="toggle-radical-search" style="
              background: linear-gradient(135deg, #007bff, #0056b3);
              color: white;
              border: none;
              padding: var(--space-md) var(--space-lg);
              border-radius: var(--radius-lg);
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s ease;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            ">
              🔍 Búsqueda por Radicales
            </button>
          </div>
          <div id="radical-search-content" style="display: none;">
            <!-- El contenido se cargará dinámicamente -->
          </div>
        </div>
      ` : ''}
      <div class="dictionary-grid" id="dictionary-grid">
        ${allWords.map(([word, data]) => {
          const details = JSON.stringify(data).replace(/'/g, '&apos;');
          return `
            <div class="word-card" data-word-raw="${word}" data-word-details='${details}' data-letter="${word[0].toUpperCase()}">
              <h3 class="word-title">${word}</h3>
              <div class="word-meta">
                <span class="meaning">${language === 'es' ? `Primera aparición: Día ${data.firstAppearance}` : `Significado: ${data.meaning}`}</span>
                <span class="lessons">Lecciones: ${data.lessons.join(', ')}</span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function setupEventListeners() {
    const searchInput = document.getElementById('word-search');
    const dictionaryGrid = document.getElementById('dictionary-grid');
    const alphabetFilter = document.getElementById('alphabet-filter');

    searchInput?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      document.querySelectorAll('.word-card').forEach(card => {
        const word = card.dataset.wordRaw.toLowerCase();
        card.style.display = word.includes(query) ? '' : 'none';
      });
      alphabetFilter.querySelector('.active')?.classList.remove('active');
    });

    alphabetFilter?.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const letter = e.target.dataset.letter;

        alphabetFilter.querySelector('.active')?.classList.remove('active');
        e.target.classList.add('active');

        document.querySelectorAll('.word-card').forEach(card => {
            if (letter === 'all' || card.dataset.letter === letter) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
        searchInput.value = '';
    });

    dictionaryGrid?.addEventListener('click', (e) => {
      const card = e.target.closest('.word-card');
      if (card) {
        console.log('Word card clicked:', card.dataset.wordRaw);
        const details = JSON.parse(card.dataset.wordDetails.replace(/&apos;/g, "'"));
        showWordDetails(card.dataset.wordRaw, details);
      }
    });
    
    // Funcionalidad de búsqueda por radicales (solo para idiomas chinos)
    const toggleRadicalBtn = document.getElementById('toggle-radical-search');
    const radicalContent = document.getElementById('radical-search-content');
    
    if (toggleRadicalBtn && radicalContent) {
      let radicalSearchLoaded = false;
      
      toggleRadicalBtn.addEventListener('click', async () => {
        if (radicalContent.style.display === 'none') {
          // Mostrar búsqueda por radicales
          radicalContent.style.display = 'block';
          toggleRadicalBtn.textContent = '🔼 Ocultar Búsqueda por Radicales';
          
          // Cargar contenido si no está cargado
          if (!radicalSearchLoaded) {
            radicalContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;"><div style="animation: spin 1s linear infinite; width: 40px; height: 40px; border: 3px solid #e9ecef; border-top: 3px solid #007bff; border-radius: 50%; margin: 0 auto 1rem;"></div>Cargando búsqueda por radicales...</div>';
            
            try {
              await loadRadicalSearchComponent();
              radicalSearchLoaded = true;
            } catch (error) {
              console.error('Error cargando búsqueda por radicales:', error);
              radicalContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc3545;">❌ Error al cargar la búsqueda por radicales</div>';
            }
          }
        } else {
          // Ocultar búsqueda por radicales
          radicalContent.style.display = 'none';
          toggleRadicalBtn.textContent = '🔍 Búsqueda por Radicales';
        }
      });
    }
  }

  // Base de datos de trazos para caracteres individuales comunes
  const characterStrokes = {
    // Radicales básicos
    "人": 2, "口": 3, "土": 3, "工": 3, "大": 3, "小": 3, "山": 3, "川": 3,
    "木": 4, "水": 4, "火": 4, "日": 4, "月": 4, "心": 4, "手": 4, "目": 5,
    "田": 5, "白": 5, "石": 5, "立": 5, "示": 5, "禾": 5, "穴": 5, "竹": 6,
    "米": 6, "糸": 6, "耳": 6, "肉": 6, "臣": 6, "自": 6, "至": 6, "舌": 6,
    "虫": 6, "血": 6, "行": 6, "衣": 6, "見": 7, "言": 7, "谷": 7, "豆": 7,
    "豕": 7, "走": 7, "足": 7, "身": 7, "車": 7, "辛": 7, "辰": 7, "酉": 7,
    "釆": 7, "里": 7, "金": 8, "長": 8, "門": 8, "阜": 8, "隶": 8, "隹": 8,
    "雨": 8, "青": 8, "非": 8, "面": 9, "革": 9, "韋": 9, "韭": 9, "音": 9,
    "頁": 9, "風": 9, "飛": 9, "食": 9, "首": 9, "香": 9, "馬": 10, "骨": 10,
    "高": 10, "髟": 10, "鬥": 10, "鬯": 10, "鬲": 10, "鬼": 10, "魚": 11,
    "鳥": 11, "鹵": 11, "鹿": 11, "麻": 11, "黃": 12, "黍": 12, "黑": 12,
    "黹": 12, "黽": 13, "鼎": 13, "鼓": 13, "鼠": 13, "鼻": 14, "齊": 14,
    "齒": 15, "龍": 16, "龜": 16, "龠": 17,
    
    // Caracteres revolucionarios comunes
    "反": 4, "抗": 7, "革": 9, "命": 8, "民": 5, "国": 8, "党": 10, "政": 9,
    "权": 6, "斗": 4, "争": 6, "战": 9, "胜": 9, "利": 7, "力": 2, "农": 6,
    "地": 6, "主": 5, "义": 3, "自": 6, "由": 5, "团": 6, "结": 9, "解": 13,
    "放": 8, "联": 12, "盟": 13, "社": 7, "会": 6, "劳": 7, "作": 7, "起": 10,
    "来": 7, "权": 6, "利": 7, "斗": 4, "争": 6, "战": 9, "胜": 9,
    
    // Números básicos
    "一": 1, "二": 2, "三": 3, "四": 5, "五": 4, "六": 4, "七": 2, "八": 2,
    "九": 2, "十": 2, "百": 6, "千": 3, "万": 3,
    
    // Otros caracteres comunes del vocabulario
    "歌": 14, "曲": 6, "唱": 11, "旗": 14, "帜": 8, "红": 9, "黑": 12, "白": 5,
    "青": 8, "黄": 11, "绿": 11, "紫": 12, "蓝": 13, "灰": 6, "棕": 12,
    "东": 5, "西": 6, "南": 9, "北": 5, "上": 3, "下": 3, "左": 5, "右": 5,
    "前": 9, "后": 6, "中": 4, "内": 4, "外": 5, "里": 7, "边": 5, "间": 7,
    "年": 6, "月": 4, "日": 4, "时": 7, "分": 4, "秒": 9, "今": 4, "明": 8,
    "昨": 9, "早": 6, "晚": 11, "夜": 8, "午": 4, "晨": 11, "夕": 3, "朝": 12
  };

  

  // Función para convertir caracteres chinos a códigos Unicode decimales - ARCHIVOS LOCALES
    

    function getToneClass(pinyin) {
    if (/[āēīōū]/.test(pinyin)) return 'tone-1';
    if (/[áéíóú]/.test(pinyin)) return 'tone-2';
    if (/[ǎěǐǒǔ]/.test(pinyin)) return 'tone-3';
    if (/[àèìòù]/.test(pinyin)) return 'tone-4';
    return 'tone-5';
  }

  function renderPinyinWithTones(pinyin) {
    if (!pinyin) return '';
    return pinyin.split(/\s+/).map(syllable => 
      `<span class="pinyin-syllable ${getToneClass(syllable)}">${syllable}</span>`
    ).join(' ');
  }

    let characterData = {};

  async function loadCharacterData() {
    try {
      const response = await fetch(`${baseUrl}data/chinese/character-data.json`);
      if (!response.ok) throw new Error('No se pudo cargar los datos de los caracteres');
      characterData = await response.json();
    } catch (err) {
      console.error('Error cargando los datos de los caracteres:', err);
    }
  }

  function getChineseStrokeGifs(chineseText) {
    if (!chineseText || typeof chineseText !== 'string') return [];
    
    const gifs = [];
    for (let i = 0; i < chineseText.length; i++) {
      const char = chineseText[i];
      if (/[\u4e00-\u9fff]/.test(char)) {
        const unicodeDecimal = char.codePointAt(0);
        // Usar datos CC-CEDICT para información del carácter
        const charData = characterData?.characters?.[char] || {};
        gifs.push({
          char: char,
          pinyin: charData.pinyin || '',
          url: `${baseUrl}data/chinese/strokes/${charData.file || `${unicodeDecimal}.gif`}`,
          attribution: "MDBG Chinese Dictionary (mdbg.net)",
          definitions: charData.definitions || [],
          traditional: charData.traditional || char
        });
      }
    }
    return gifs;
  }

  function showWordDetails(word, data) {
    let detailsHtml = `<h2>${word}</h2>`;

    data.entries.forEach((entry, index) => {
        const translations = entry.allTranslations || entry.translations;
        const category = translations.grammaticalCategory || 'N/A';

        detailsHtml += `<div class="modal-entry" style="margin-bottom: 1rem; border-bottom: 1px solid #ccc; padding-bottom: 1rem;">`;
        detailsHtml += `<p><strong>Significado ${index + 1}:</strong> ${entry.meaning}</p>`;
        detailsHtml += `<p style="font-style: italic; color: var(--color-text-secondary); margin-bottom: var(--space-md);">Categoría: ${category}</p>`;

        if (translations) {
            detailsHtml += '<h4>Traducciones:</h4><ul>';
            // Mostrar el significado primero, luego los elementos lingüísticos
            const langOrder = ['es', 'en', 'de', 'pt', 'ru', 'ruRom'];
            langOrder.forEach(lang => {
                if (translations[lang]) {
                    detailsHtml += `<li><strong>${lang}:</strong> ${translations[lang]}</li>`;
                }
            });
            // Chino: mostrar hanzi primero, luego pinyin, y información adicional
            if (translations.zh) {
                detailsHtml += `<li><strong>zh (hanzi):</strong> ${translations.zh}</li>`;
            }
            if (translations.zhPinyin) {
                detailsHtml += `<li><strong>zh (pinyin):</strong> ${renderPinyinWithTones(translations.zhPinyin)}</li>`;
            }
            if (translations.zhStrokes) {
                detailsHtml += `<li><strong>zh (trazos):</strong> ${translations.zhStrokes}</li>`;
            }
            if (translations.zhRadical) {
                detailsHtml += `<li><strong>zh (radical):</strong> ${translations.zhRadical}</li>`;
            }
            if (translations.zhStructure) {
                detailsHtml += `<li><strong>zh (estructura):</strong> ${translations.zhStructure}</li>`;
            }
            detailsHtml += '</ul>';
        }

        // Mostrar todas las lecciones donde aparece la palabra
        const lessons = entry.lessons || [entry.day];
        if (lessons.length === 1) {
            detailsHtml += `<p><a href="${baseUrl}blog/${entry.source}/" class="post-link">Ver en la lección del día ${lessons[0]}</a></p>`;
        } else {
            detailsHtml += `<p><strong>Aparece en las lecciones:</strong> `;
            lessons.forEach((day, idx) => {
                if (idx > 0) detailsHtml += ', ';
                detailsHtml += `<a href="${baseUrl}blog/dia-${day.toString().padStart(2, '0')}/" class="post-link">Día ${day}</a>`;
            });
            detailsHtml += `</p>`;
        }
        detailsHtml += `</div>`;
    });

    // Agregar trazos de caracteres chinos si aplica
    const containsChinese = /[\u4e00-\u9fff]/.test(word) || 
                           (data.entries[0]?.allTranslations?.zh && /[\u4e00-\u9fff]/.test(data.entries[0].allTranslations.zh));
    
    if (language === 'zh' || language === 'zh-pinyin' || containsChinese) {
      let chineseText = '';
      let pinyinText = '';
      
      if (language === 'zh') {
        chineseText = word;
        pinyinText = data.entries[0]?.allTranslations?.zhPinyin || data.entries[0]?.translations?.zhPinyin || '';
      } else if (language === 'zh-pinyin') {
        chineseText = data.entries[0]?.allTranslations?.zh || data.entries[0]?.translations?.zh || '';
        pinyinText = word;
      } else if (containsChinese && /[\u4e00-\u9fff]/.test(word)) {
        chineseText = word;
        pinyinText = data.entries[0]?.allTranslations?.zhPinyin || data.entries[0]?.translations?.zhPinyin || '';
      } else if (containsChinese && data.entries[0]?.allTranslations?.zh) {
        chineseText = data.entries[0].allTranslations.zh;
        pinyinText = data.entries[0]?.allTranslations?.zhPinyin || data.entries[0]?.translations?.zhPinyin || '';
      }
      
      if (chineseText && typeof chineseText === 'string') {
        const strokeGifs = getChineseStrokeGifs(chineseText);
        
        // Extraer pinyin individual para cada carácter usando datos CC-CEDICT
        let pinyinSyllables = [];
        
        if (pinyinText && pinyinText.split(' ').length === chineseText.length) {
          // Si el número de sílabas coincide con el número de caracteres, usar directamente
          pinyinSyllables = pinyinText.split(' ');
        } else {
          // Usar datos CC-CEDICT individuales para cada carácter
          for (let i = 0; i < chineseText.length; i++) {
            const char = chineseText[i];
            if (/[\u4e00-\u9fff]/.test(char)) {
              // Buscar datos CC-CEDICT para este carácter
              const charData = characterData?.characters?.[char];
              if (charData && charData.pinyin) {
                pinyinSyllables.push(charData.pinyin);
              } else {
                // Fallback: intentar extraer de la palabra completa
                const wordSyllables = pinyinText ? pinyinText.split(' ') : [];
                pinyinSyllables.push(wordSyllables[i] || char);
              }
            } else {
              // No es carácter chino, mantener tal como está
              pinyinSyllables.push(char);
            }
          }
          console.log(`Using CC-CEDICT individual pinyin for "${chineseText}": [${pinyinSyllables.join(', ')}]`);
        }
        
        if (strokeGifs.length > 0) {
          detailsHtml += `<div class="stroke-section">`;
          detailsHtml += `<h4>✍️ Orden de trazos (${strokeGifs.length} carácter${strokeGifs.length > 1 ? 'es' : ''}):</h4>`;
          detailsHtml += `<div class="stroke-gifs">`;
          strokeGifs.forEach((gif, idx) => {
            const syllablePinyin = pinyinSyllables[idx] || gif.pinyin || gif.char;
            const toneClass = getToneClass(syllablePinyin);
            detailsHtml += `<div class="stroke-gif">`;
            // Añadir numeración para múltiples caracteres
            if (strokeGifs.length > 1) {
              detailsHtml += `<div style="font-size: 0.7rem; color: #999; margin-bottom: 0.25rem;">${idx + 1}</div>`;
            }
            detailsHtml += `<img src="${gif.url}" alt="Trazos de ${gif.char}" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'width:100px;height:100px;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#999;font-size:0.8rem;text-align:center;\\'>No disponible<br>${gif.char}</div>'">`;
            detailsHtml += `<div class="character-pinyin pinyin-syllable ${toneClass}">${syllablePinyin}</div>`;
            detailsHtml += `</div>`;
          });
          detailsHtml += `</div>`;
          // Mostrar los caracteres en grande
          detailsHtml += `<div class="chinese-large-display">`;
          detailsHtml += `<div class="chinese-large-text">${chineseText}</div>`;
          detailsHtml += `</div>`;
          // Atribución para trazos
          detailsHtml += `<div class="stroke-attribution">`;
          detailsHtml += `<small>Orden de trazos © <a href="https://www.mdbg.net/" target="_blank" rel="noopener">MDBG Chinese Dictionary</a></small>`;
          detailsHtml += `</div>`;
          
          // Análisis de radicales para cada caracter
          detailsHtml += `<div class="radical-analysis-section">`;
          detailsHtml += `<h4>🔍 Análisis de Radicales</h4>`;
          strokeGifs.forEach((gif, idx) => {
            detailsHtml += `<div class="radical-analyzer-container" data-character="${gif.char}">`;
            detailsHtml += `  <div class="radical-loading-mini">`;
            detailsHtml += `    <div class="loading-mini"></div>`;
            detailsHtml += `    <span>Analizando ${gif.char}...</span>`;
            detailsHtml += `  </div>`;
            detailsHtml += `</div>`;
          });
          detailsHtml += `</div>`;
          
          detailsHtml += `</div>`;
        }
      }
    }



    modalBody.innerHTML = detailsHtml;
    
    // Cargar análisis de radicales para caracteres chinos
    loadRadicalAnalysis();
    
    const currentModal = document.getElementById('word-modal');
    if (currentModal) {
      console.log('Setting modal display to flex');
      currentModal.style.setProperty('display', 'flex', 'important');
    } else {
      console.error('Modal element not found!');
    }
  }

  function closeModal() {
    const currentModal = document.getElementById('word-modal');
    if (currentModal) {
      currentModal.style.setProperty('display', 'none', 'important');
    }
  }

  async function init() {
    // Asegurarse de que el modal esté oculto al inicio
    const currentModal = document.getElementById('word-modal');
    if (currentModal) {
      currentModal.style.setProperty('display', 'none', 'important');
    }
    
    await loadDictionaryData();
    await loadCharacterData();
    setupEventListeners();
    
    // Configurar event listeners del modal después de cargar el contenido
    setupModalListeners();
  }

  function setupModalListeners() {
    // Limpiar listeners previos
    const newCloseBtn = document.querySelector('.close-button');
    const newModal = document.getElementById('word-modal');
    
    if (newCloseBtn) {
      newCloseBtn.addEventListener('click', closeModal);
    }
    
    if (newModal) {
      newModal.addEventListener('click', (e) => {
        if (e.target === newModal) {
          closeModal();
        }
      });
    }
  }
  
  // Base de datos de radicales Kangxi reales para caracteres individuales
  const kangxiRadicals = {
    // Radicales que son caracteres por sí mismos
    "土": { radical: "土", meaning: "tierra", strokes: 3, radicalStrokes: 3 },
    "人": { radical: "人", meaning: "persona", strokes: 2, radicalStrokes: 2 },
    "工": { radical: "工", meaning: "trabajo", strokes: 3, radicalStrokes: 3 },
    "木": { radical: "木", meaning: "árbol", strokes: 4, radicalStrokes: 4 },
    "水": { radical: "水", meaning: "agua", strokes: 4, radicalStrokes: 4 },
    "火": { radical: "火", meaning: "fuego", strokes: 4, radicalStrokes: 4 },
    "金": { radical: "金", meaning: "metal", strokes: 8, radicalStrokes: 8 },
    "口": { radical: "口", meaning: "boca", strokes: 3, radicalStrokes: 3 },
    "心": { radical: "心", meaning: "corazón", strokes: 4, radicalStrokes: 4 },
    "手": { radical: "手", meaning: "mano", strokes: 4, radicalStrokes: 4 },
    "日": { radical: "日", meaning: "sol", strokes: 4, radicalStrokes: 4 },
    "月": { radical: "月", meaning: "luna", strokes: 4, radicalStrokes: 4 },
    
    // Caracteres compuestos con sus radicales reales
    "地": { radical: "土", meaning: "tierra", strokes: 6, radicalStrokes: 3 },
    "国": { radical: "囗", meaning: "recinto", strokes: 8, radicalStrokes: 3 },
    "民": { radical: "氏", meaning: "clan", strokes: 5, radicalStrokes: 4 },
    "农": { radical: "辰", meaning: "tiempo", strokes: 6, radicalStrokes: 7 },
    "工人": { radical: "工", meaning: "trabajo", strokes: 7, radicalStrokes: 3 },
    "反": { radical: "厂", meaning: "acantilado", strokes: 4, radicalStrokes: 2 },
    "抗": { radical: "手", meaning: "mano", strokes: 7, radicalStrokes: 4 },
    "革": { radical: "革", meaning: "cuero", strokes: 9, radicalStrokes: 9 },
    "命": { radical: "口", meaning: "boca", strokes: 8, radicalStrokes: 3 },
    "权": { radical: "木", meaning: "árbol", strokes: 6, radicalStrokes: 4 },
    "利": { radical: "刀", meaning: "cuchillo", strokes: 7, radicalStrokes: 2 },
    "力": { radical: "力", meaning: "fuerza", strokes: 2, radicalStrokes: 2 },
    "斗": { radical: "斗", meaning: "lucha", strokes: 4, radicalStrokes: 4 },
    "争": { radical: "爪", meaning: "garra", strokes: 6, radicalStrokes: 4 },
    "战": { radical: "戈", meaning: "lanza", strokes: 9, radicalStrokes: 4 },
    "胜": { radical: "月", meaning: "carne", strokes: 9, radicalStrokes: 4 },
    "团": { radical: "囗", meaning: "recinto", strokes: 6, radicalStrokes: 3 },
    "结": { radical: "糸", meaning: "seda", strokes: 9, radicalStrokes: 6 },
    "解": { radical: "角", meaning: "cuerno", strokes: 13, radicalStrokes: 7 },
    "放": { radical: "攴", meaning: "golpear", strokes: 8, radicalStrokes: 4 },
    "联": { radical: "耳", meaning: "oreja", strokes: 12, radicalStrokes: 6 },
    "盟": { radical: "皿", meaning: "recipiente", strokes: 13, radicalStrokes: 5 },
    "社": { radical: "示", meaning: "sagrado", strokes: 7, radicalStrokes: 5 },
    "会": { radical: "人", meaning: "persona", strokes: 6, radicalStrokes: 2 },
    "劳": { radical: "力", meaning: "fuerza", strokes: 7, radicalStrokes: 2 },
    "作": { radical: "人", meaning: "persona", strokes: 7, radicalStrokes: 2 },
    "起": { radical: "走", meaning: "caminar", strokes: 10, radicalStrokes: 7 },
    "来": { radical: "木", meaning: "árbol", strokes: 7, radicalStrokes: 4 },
    "自": { radical: "自", meaning: "uno mismo", strokes: 6, radicalStrokes: 6 },
    "由": { radical: "田", meaning: "campo", strokes: 5, radicalStrokes: 5 },
    "主": { radical: "丶", meaning: "punto", strokes: 5, radicalStrokes: 1 },
    "义": { radical: "丶", meaning: "punto", strokes: 3, radicalStrokes: 1 },
    "红": { radical: "糸", meaning: "seda", strokes: 9, radicalStrokes: 6 },
    "旗": { radical: "方", meaning: "cuadrado", strokes: 14, radicalStrokes: 4 },
    "帜": { radical: "巾", meaning: "paño", strokes: 8, radicalStrokes: 3 },
    
    // Caracteres adicionales del vocabulario
    "一": { radical: "一", meaning: "uno", strokes: 1, radicalStrokes: 1 },
    "下": { radical: "一", meaning: "uno", strokes: 3, radicalStrokes: 1 },
    "不": { radical: "一", meaning: "uno", strokes: 4, radicalStrokes: 1 },
    "世": { radical: "一", meaning: "uno", strokes: 5, radicalStrokes: 1 },
    "东": { radical: "木", meaning: "árbol", strokes: 5, radicalStrokes: 4 },
    "主": { radical: "丶", meaning: "punto", strokes: 5, radicalStrokes: 1 },
    "举": { radical: "丶", meaning: "punto", strokes: 9, radicalStrokes: 1 },
    "么": { radical: "丿", meaning: "línea", strokes: 3, radicalStrokes: 1 },
    "之": { radical: "丶", meaning: "punto", strokes: 3, radicalStrokes: 1 },
    "书": { radical: "乙", meaning: "segundo", strokes: 4, radicalStrokes: 1 },
    "争": { radical: "爪", meaning: "garra", strokes: 6, radicalStrokes: 4 },
    "互": { radical: "二", meaning: "dos", strokes: 4, radicalStrokes: 2 },
    "亡": { radical: "亠", meaning: "techo", strokes: 3, radicalStrokes: 2 },
    "产": { radical: "亠", meaning: "techo", strokes: 6, radicalStrokes: 2 },
    "什": { radical: "人", meaning: "persona", strokes: 4, radicalStrokes: 2 },
    "们": { radical: "人", meaning: "persona", strokes: 5, radicalStrokes: 2 },
    "会": { radical: "人", meaning: "persona", strokes: 6, radicalStrokes: 2 },
    "伟": { radical: "人", meaning: "persona", strokes: 6, radicalStrokes: 2 },
    "作": { radical: "人", meaning: "persona", strokes: 7, radicalStrokes: 2 },
    "光": { radical: "儿", meaning: "niño", strokes: 6, radicalStrokes: 2 },
    "党": { radical: "儿", meaning: "niño", strokes: 10, radicalStrokes: 2 },
    "公": { radical: "八", meaning: "ocho", strokes: 4, radicalStrokes: 2 },
    "共": { radical: "八", meaning: "ocho", strokes: 6, radicalStrokes: 2 },
    "兵": { radical: "八", meaning: "ocho", strokes: 7, radicalStrokes: 2 },
    "写": { radical: "冖", meaning: "cubierta", strokes: 5, radicalStrokes: 2 },
    "军": { radical: "冖", meaning: "cubierta", strokes: 6, radicalStrokes: 2 },
    "农": { radical: "冖", meaning: "cubierta", strokes: 6, radicalStrokes: 2 },
    "出": { radical: "凵", meaning: "recipiente", strokes: 5, radicalStrokes: 2 },
    "击": { radical: "凵", meaning: "recipiente", strokes: 7, radicalStrokes: 2 },
    "利": { radical: "刀", meaning: "cuchillo", strokes: 7, radicalStrokes: 2 },
    "前": { radical: "刀", meaning: "cuchillo", strokes: 9, radicalStrokes: 2 },
    "力": { radical: "力", meaning: "fuerza", strokes: 2, radicalStrokes: 2 },
    "动": { radical: "力", meaning: "fuerza", strokes: 6, radicalStrokes: 2 },
    "助": { radical: "力", meaning: "fuerza", strokes: 7, radicalStrokes: 2 },
    "劳": { radical: "力", meaning: "fuerza", strokes: 7, radicalStrokes: 2 },
    "升": { radical: "十", meaning: "diez", strokes: 4, radicalStrokes: 2 },
    "卫": { radical: "卩", meaning: "sello", strokes: 3, radicalStrokes: 2 },
    "历": { radical: "厂", meaning: "acantilado", strokes: 4, radicalStrokes: 2 },
    "压": { radical: "厂", meaning: "acantilado", strokes: 6, radicalStrokes: 2 },
    "反": { radical: "厂", meaning: "acantilado", strokes: 4, radicalStrokes: 2 },
    "受": { radical: "又", meaning: "otra vez", strokes: 8, radicalStrokes: 2 },
    "口": { radical: "口", meaning: "boca", strokes: 3, radicalStrokes: 3 },
    "召": { radical: "口", meaning: "boca", strokes: 5, radicalStrokes: 3 },
    "史": { radical: "口", meaning: "boca", strokes: 5, radicalStrokes: 3 },
    "同": { radical: "口", meaning: "boca", strokes: 6, radicalStrokes: 3 },
    "听": { radical: "口", meaning: "boca", strokes: 7, radicalStrokes: 3 },
    "员": { radical: "口", meaning: "boca", strokes: 7, radicalStrokes: 3 },
    "和": { radical: "口", meaning: "boca", strokes: 8, radicalStrokes: 3 },
    "咒": { radical: "口", meaning: "boca", strokes: 8, radicalStrokes: 3 },
    "唤": { radical: "口", meaning: "boca", strokes: 10, radicalStrokes: 3 },
    "唱": { radical: "口", meaning: "boca", strokes: 11, radicalStrokes: 3 },
    "团": { radical: "囗", meaning: "recinto", strokes: 6, radicalStrokes: 3 },
    "国": { radical: "囗", meaning: "recinto", strokes: 8, radicalStrokes: 3 },
    "圣": { radical: "土", meaning: "tierra", strokes: 5, radicalStrokes: 3 },
    "地": { radical: "土", meaning: "tierra", strokes: 6, radicalStrokes: 3 },
    "场": { radical: "土", meaning: "tierra", strokes: 6, radicalStrokes: 3 },
    "坏": { radical: "土", meaning: "tierra", strokes: 7, radicalStrokes: 3 },
    "垄": { radical: "土", meaning: "tierra", strokes: 8, radicalStrokes: 3 },
    "埃": { radical: "土", meaning: "tierra", strokes: 10, radicalStrokes: 3 },
    "士": { radical: "士", meaning: "erudito", strokes: 3, radicalStrokes: 3 },
    "大": { radical: "大", meaning: "grande", strokes: 3, radicalStrokes: 3 },
    "天": { radical: "大", meaning: "grande", strokes: 4, radicalStrokes: 3 },
    "太": { radical: "大", meaning: "grande", strokes: 4, radicalStrokes: 3 },
    "头": { radical: "大", meaning: "grande", strokes: 5, radicalStrokes: 3 },
    "奴": { radical: "女", meaning: "mujer", strokes: 5, radicalStrokes: 3 },
    "子": { radical: "子", meaning: "hijo", strokes: 3, radicalStrokes: 3 },
    "孩": { radical: "子", meaning: "hijo", strokes: 9, radicalStrokes: 3 },
    "密": { radical: "宀", meaning: "techo", strokes: 11, radicalStrokes: 3 },
    "将": { radical: "寸", meaning: "pulgada", strokes: 9, radicalStrokes: 3 },
    "居": { radical: "尸", meaning: "cadáver", strokes: 8, radicalStrokes: 3 },
    "山": { radical: "山", meaning: "montaña", strokes: 3, radicalStrokes: 3 },
    "帆": { radical: "巾", meaning: "paño", strokes: 6, radicalStrokes: 3 },
    "席": { radical: "巾", meaning: "paño", strokes: 10, radicalStrokes: 3 },
    "幻": { radical: "幺", meaning: "pequeño", strokes: 4, radicalStrokes: 3 },
    "府": { radical: "广", meaning: "edificio", strokes: 8, radicalStrokes: 3 },
    "强": { radical: "弓", meaning: "arco", strokes: 12, radicalStrokes: 3 },
    "待": { radical: "彳", meaning: "paso", strokes: 9, radicalStrokes: 3 },
    "御": { radical: "彳", meaning: "paso", strokes: 12, radicalStrokes: 3 },
    "志": { radical: "心", meaning: "corazón", strokes: 7, radicalStrokes: 4 },
    "性": { radical: "心", meaning: "corazón", strokes: 8, radicalStrokes: 4 },
    "总": { radical: "心", meaning: "corazón", strokes: 9, radicalStrokes: 4 },
    "恒": { radical: "心", meaning: "corazón", strokes: 9, radicalStrokes: 4 },
    "想": { radical: "心", meaning: "corazón", strokes: 13, radicalStrokes: 4 },
    "愚": { radical: "心", meaning: "corazón", strokes: 13, radicalStrokes: 4 },
    "战": { radical: "戈", meaning: "lanza", strokes: 9, radicalStrokes: 4 },
    "抗": { radical: "手", meaning: "mano", strokes: 7, radicalStrokes: 4 },
    "拳": { radical: "手", meaning: "mano", strokes: 10, radicalStrokes: 4 },
    "捍": { radical: "手", meaning: "mano", strokes: 10, radicalStrokes: 4 },
    "摇": { radical: "手", meaning: "mano", strokes: 13, radicalStrokes: 4 },
    "撼": { radical: "手", meaning: "mano", strokes: 16, radicalStrokes: 4 },
    "放": { radical: "攴", meaning: "golpear", strokes: 8, radicalStrokes: 4 },
    "政": { radical: "攴", meaning: "golpear", strokes: 9, radicalStrokes: 4 },
    "敌": { radical: "攴", meaning: "golpear", strokes: 10, radicalStrokes: 4 },
    "救": { radical: "攴", meaning: "golpear", strokes: 11, radicalStrokes: 4 },
    "散": { radical: "攴", meaning: "golpear", strokes: 12, radicalStrokes: 4 },
    "斗": { radical: "斗", meaning: "lucha", strokes: 4, radicalStrokes: 4 },
    "斯": { radical: "斤", meaning: "hacha", strokes: 12, radicalStrokes: 4 },
    "方": { radical: "方", meaning: "cuadrado", strokes: 4, radicalStrokes: 4 },
    "无": { radical: "无", meaning: "no tener", strokes: 4, radicalStrokes: 4 },
    "明": { radical: "日", meaning: "sol", strokes: 8, radicalStrokes: 4 },
    "星": { radical: "日", meaning: "sol", strokes: 9, radicalStrokes: 4 },
    "是": { radical: "日", meaning: "sol", strokes: 9, radicalStrokes: 4 },
    "暴": { radical: "日", meaning: "sol", strokes: 15, radicalStrokes: 4 },
    "有": { radical: "月", meaning: "luna", strokes: 6, radicalStrokes: 4 },
    "权": { radical: "木", meaning: "árbol", strokes: 6, radicalStrokes: 4 },
    "来": { radical: "木", meaning: "árbol", strokes: 7, radicalStrokes: 4 },
    "死": { radical: "歹", meaning: "malo", strokes: 6, radicalStrokes: 4 },
    "民": { radical: "氏", meaning: "clan", strokes: 5, radicalStrokes: 4 },
    "水": { radical: "水", meaning: "agua", strokes: 4, radicalStrokes: 4 },
    "永": { radical: "水", meaning: "agua", strokes: 5, radicalStrokes: 4 },
    "汗": { radical: "水", meaning: "agua", strokes: 6, radicalStrokes: 4 },
    "沟": { radical: "水", meaning: "agua", strokes: 7, radicalStrokes: 4 },
    "没": { radical: "水", meaning: "agua", strokes: 7, radicalStrokes: 4 },
    "沸": { radical: "水", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "治": { radical: "水", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "法": { radical: "水", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "波": { radical: "水", meaning: "agua", strokes: 8, radicalStrokes: 4 },
    "浇": { radical: "水", meaning: "agua", strokes: 9, radicalStrokes: 4 },
    "浪": { radical: "水", meaning: "agua", strokes: 10, radicalStrokes: 4 },
    "液": { radical: "水", meaning: "agua", strokes: 11, radicalStrokes: 4 },
    "港": { radical: "水", meaning: "agua", strokes: 12, radicalStrokes: 4 },
    "游": { radical: "水", meaning: "agua", strokes: 12, radicalStrokes: 4 },
    "灌": { radical: "水", meaning: "agua", strokes: 21, radicalStrokes: 4 },
    "灭": { radical: "火", meaning: "fuego", strokes: 5, radicalStrokes: 4 },
    "然": { radical: "火", meaning: "fuego", strokes: 12, radicalStrokes: 4 },
    "犁": { radical: "牛", meaning: "buey", strokes: 11, radicalStrokes: 4 },
    "犹": { radical: "犬", meaning: "perro", strokes: 12, radicalStrokes: 4 },
    "现": { radical: "玉", meaning: "jade", strokes: 8, radicalStrokes: 5 },
    "理": { radical: "玉", meaning: "jade", strokes: 11, radicalStrokes: 5 },
    "界": { radical: "田", meaning: "campo", strokes: 9, radicalStrokes: 5 },
    "痛": { radical: "疒", meaning: "enfermedad", strokes: 12, radicalStrokes: 5 },
    "的": { radical: "白", meaning: "blanco", strokes: 8, radicalStrokes: 5 },
    "盗": { radical: "皿", meaning: "recipiente", strokes: 11, radicalStrokes: 5 },
    "盟": { radical: "皿", meaning: "recipiente", strokes: 13, radicalStrokes: 5 },
    "破": { radical: "石", meaning: "piedra", strokes: 10, radicalStrokes: 5 },
    "社": { radical: "示", meaning: "sagrado", strokes: 7, radicalStrokes: 5 },
    "祖": { radical: "示", meaning: "sagrado", strokes: 9, radicalStrokes: 5 },
    "神": { radical: "示", meaning: "sagrado", strokes: 9, radicalStrokes: 5 },
    "私": { radical: "禾", meaning: "grano", strokes: 7, radicalStrokes: 5 },
    "秘": { radical: "禾", meaning: "grano", strokes: 10, radicalStrokes: 5 },
    "空": { radical: "穴", meaning: "cueva", strokes: 8, radicalStrokes: 5 },
    "窃": { radical: "穴", meaning: "cueva", strokes: 9, radicalStrokes: 5 },
    "章": { radical: "立", meaning: "estar de pie", strokes: 11, radicalStrokes: 5 },
    "第": { radical: "竹", meaning: "bambú", strokes: 11, radicalStrokes: 6 },
    "等": { radical: "竹", meaning: "bambú", strokes: 12, radicalStrokes: 6 },
    "管": { radical: "竹", meaning: "bambú", strokes: 14, radicalStrokes: 6 },
    "篇": { radical: "竹", meaning: "bambú", strokes: 15, radicalStrokes: 6 },
    "级": { radical: "糸", meaning: "seda", strokes: 6, radicalStrokes: 6 },
    "线": { radical: "糸", meaning: "seda", strokes: 8, radicalStrokes: 6 },
    "结": { radical: "糸", meaning: "seda", strokes: 9, radicalStrokes: 6 },
    "维": { radical: "糸", meaning: "seda", strokes: 11, radicalStrokes: 6 },
    "罢": { radical: "罒", meaning: "red", strokes: 10, radicalStrokes: 5 },
    "者": { radical: "者", meaning: "persona", strokes: 8, radicalStrokes: 8 },
    "联": { radical: "耳", meaning: "oreja", strokes: 12, radicalStrokes: 6 },
    "胜": { radical: "月", meaning: "carne", strokes: 9, radicalStrokes: 4 },
    "脉": { radical: "月", meaning: "carne", strokes: 9, radicalStrokes: 4 },
    "腾": { radical: "月", meaning: "carne", strokes: 13, radicalStrokes: 4 },
    "船": { radical: "舟", meaning: "barco", strokes: 11, radicalStrokes: 6 },
    "色": { radical: "色", meaning: "color", strokes: 6, radicalStrokes: 6 },
    "苏": { radical: "艹", meaning: "hierba", strokes: 7, radicalStrokes: 3 },
    "苦": { radical: "艹", meaning: "hierba", strokes: 8, radicalStrokes: 3 },
    "虽": { radical: "虫", meaning: "insecto", strokes: 9, radicalStrokes: 6 },
    "蠢": { radical: "虫", meaning: "insecto", strokes: 21, radicalStrokes: 6 },
    "血": { radical: "血", meaning: "sangre", strokes: 6, radicalStrokes: 6 },
    "行": { radical: "行", meaning: "caminar", strokes: 6, radicalStrokes: 6 },
    "袖": { radical: "衣", meaning: "ropa", strokes: 10, radicalStrokes: 6 },
    "被": { radical: "衣", meaning: "ropa", strokes: 10, radicalStrokes: 6 },
    "西": { radical: "西", meaning: "oeste", strokes: 6, radicalStrokes: 6 },
    "见": { radical: "見", meaning: "ver", strokes: 4, radicalStrokes: 7 },
    "解": { radical: "角", meaning: "cuerno", strokes: 13, radicalStrokes: 7 },
    "诅": { radical: "言", meaning: "palabra", strokes: 8, radicalStrokes: 7 },
    "语": { radical: "言", meaning: "palabra", strokes: 9, radicalStrokes: 7 },
    "起": { radical: "走", meaning: "caminar", strokes: 10, radicalStrokes: 7 },
    "运": { radical: "辶", meaning: "camino", strokes: 7, radicalStrokes: 3 },
    "进": { radical: "辶", meaning: "camino", strokes: 7, radicalStrokes: 3 },
    "远": { radical: "辶", meaning: "camino", strokes: 7, radicalStrokes: 3 },
    "迫": { radical: "辶", meaning: "camino", strokes: 8, radicalStrokes: 3 },
    "都": { radical: "邑", meaning: "ciudad", strokes: 10, radicalStrokes: 7 },
    "链": { radical: "金", meaning: "metal", strokes: 11, radicalStrokes: 8 },
    "锁": { radical: "金", meaning: "metal", strokes: 12, radicalStrokes: 8 },
    "队": { radical: "阜", meaning: "montículo", strokes: 4, radicalStrokes: 8 },
    "防": { radical: "阜", meaning: "montículo", strokes: 6, radicalStrokes: 8 },
    "阳": { radical: "阜", meaning: "montículo", strokes: 6, radicalStrokes: 8 },
    "阶": { radical: "阜", meaning: "montículo", strokes: 8, radicalStrokes: 8 },
    "际": { radical: "阜", meaning: "montículo", strokes: 8, radicalStrokes: 8 },
    "隶": { radical: "隶", meaning: "sirviente", strokes: 8, radicalStrokes: 8 },
    "雇": { radical: "隹", meaning: "pájaro", strokes: 12, radicalStrokes: 8 },
    "领": { radical: "頁", meaning: "cabeza", strokes: 11, radicalStrokes: 9 },
    "风": { radical: "風", meaning: "viento", strokes: 4, radicalStrokes: 9 },
    "饥": { radical: "食", meaning: "comida", strokes: 6, radicalStrokes: 9 },
    "饿": { radical: "食", meaning: "comida", strokes: 10, radicalStrokes: 9 },
    "黎": { radical: "黍", meaning: "mijo", strokes: 15, radicalStrokes: 12 },
    "黑": { radical: "黑", meaning: "negro", strokes: 12, radicalStrokes: 12 }
  };

  // Función para generar análisis de radicales usando base de datos Kangxi real
  async function loadRadicalAnalysis() {
    const containers = document.querySelectorAll('.radical-analyzer-container');
    if (containers.length === 0) return;
    
    containers.forEach(async (container) => {
      const character = container.dataset.character;
      
      // Buscar en la base de datos Kangxi real
      const kangxiData = kangxiRadicals[character];
      
      if (kangxiData) {
        // Intentar obtener trazos exactos de MDBG via Unicode
        const unicodeDecimal = character.codePointAt(0);
        let strokeCount = kangxiData.strokes;
        
        // Intentar obtener información más precisa (simulando consulta a MDBG)
        try {
          // En una implementación real, aquí consultarías la API de MDBG
          // Por ahora usamos la base de datos local
          strokeCount = kangxiData.strokes;
        } catch (error) {
          console.log(`ℹ️ Usando trazos de base de datos local para ${character}`);
        }
        
        const characterData = {
          character: character,
          radical: kangxiData.radical,
          radicalMeaning: kangxiData.meaning,
          strokes: strokeCount,
          radicalStrokes: kangxiData.radicalStrokes,
          isRevolutionary: isRevolutionaryCharacter(character),
          source: "Base de datos Kangxi"
        };
        
        const analysisHTML = generateKangxiRadicalHTML(characterData);
        container.innerHTML = analysisHTML;
        console.log(`✅ Radical Kangxi cargado para: ${character} - ${kangxiData.radical} (${kangxiData.meaning})`);
      } else {
        container.innerHTML = `<span style="color: #6c757d;">📝 Análisis de ${character} en desarrollo</span>`;
        console.log(`ℹ️ No se encontró radical Kangxi para: ${character}`);
      }
    });
  }
  
  // Función para determinar si un carácter es revolucionario
  function isRevolutionaryCharacter(character) {
    const revolutionaryChars = [
      "反", "抗", "革", "命", "民", "国", "党", "政", "权", "斗", "争", "战",
      "胜", "利", "力", "工", "农", "土", "地", "人", "主", "义", "自", "由",
      "团", "结", "解", "放", "联", "盟", "社", "会", "劳", "作", "起", "来"
    ];
    return revolutionaryChars.includes(character);
  }

  // Función para generar HTML de radical usando base de datos Kangxi
  function generateKangxiRadicalHTML(data) {
    const isRevolutionary = data.isRevolutionary;
    
    let html = `
      <div class="radical-content">
        <div class="radical-header">
          <div class="radical-display">${data.character}</div>
          ${isRevolutionary ? '<span class="revolutionary-badge">🚩 Revolucionario</span>' : ''}
        </div>
    `;
    
    // Información del radical Kangxi
    html += `
      <div style="margin-bottom: 0.5rem;">
        <strong>Radical Kangxi:</strong> <span class="radical-display" style="font-size: 1.2rem;">${data.radical}</span>
      </div>
      <div class="radical-meaning">
        ${data.radicalMeaning}
      </div>
    `;
    
    // Información de trazos precisa
    html += `
      <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
        📏 <strong>Trazos del carácter:</strong> ${data.strokes}
      </div>
      <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #666;">
        🎯 <strong>Trazos del radical:</strong> ${data.radicalStrokes}
      </div>
    `;
    
    // Fuente de datos
    html += `
      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #999;">
        📖 Fuente: ${data.source}
      </div>
    `;
    
    // Contexto revolucionario
    if (isRevolutionary) {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #dc3545; font-weight: 500;">
          🚩 Carácter clave en vocabulario revolucionario
        </div>
      `;
    }
    
    html += `</div>`;
    return html;
  }

  // Función para generar HTML de radical usando datos del diccionario
  function generateRadicalHTMLFromDictionary(data) {
    const isRevolutionary = data.isRevolutionary;
    
    // Extraer radical limpio (sin paréntesis)
    let radicalChar = data.radical;
    let radicalMeaning = "";
    
    const radicalMatch = data.radical.match(/^([^\s(]+)\s*\(([^)]+)\)/);
    if (radicalMatch) {
      radicalChar = radicalMatch[1];
      radicalMeaning = radicalMatch[2];
    }
    
    let html = `
      <div class="radical-content">
        <div class="radical-header">
          <div class="radical-display">${data.character}</div>
          ${isRevolutionary ? '<span class="revolutionary-badge">🚩 Revolucionario</span>' : ''}
        </div>
    `;
    
    // Información del radical
    html += `
      <div style="margin-bottom: 0.5rem;">
        <strong>Radical:</strong> <span class="radical-display" style="font-size: 1.2rem;">${radicalChar}</span>
      </div>
      <div class="radical-meaning">
        ${radicalMeaning || 'Significado no disponible'}
      </div>
    `;
    
    // Información adicional
    if (data.strokes && data.strokes !== "?") {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
          📏 <strong>Trazos:</strong> ${data.strokes} <small style="color: #999;">(aproximado)</small>
        </div>
      `;
    }
    
    if (data.structure && data.structure !== "desconocida") {
      html += `
        <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #666;">
          🏗️ <strong>Estructura:</strong> ${data.structure}
        </div>
      `;
    }
    
    // Significado del carácter en español
    if (data.meaning) {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6c757d; font-style: italic;">
          💡 ${data.meaning}
        </div>
      `;
    }
    
    // Contexto revolucionario
    if (isRevolutionary) {
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #dc3545; font-weight: 500;">
          🚩 Carácter clave en vocabulario revolucionario
        </div>
      `;
    }
    
    html += `</div>`;
    return html;
  }

  function generateRadicalHTML(analysis) {
    const isRevolutionary = analysis.revolutionaryRelevance;
    
    let html = `
      <div class="radical-content">
        <div class="radical-header">
          <div class="radical-display">${analysis.character}</div>
          ${isRevolutionary ? '<span class="revolutionary-badge">🚩 Revolucionario</span>' : ''}
        </div>
    `;
    
    // Información del radical
    if (analysis.radicalData && analysis.radicalData.meaning) {
      html += `
        <div style="margin-bottom: 0.5rem;">
          <strong>Radical:</strong> <span class="radical-display" style="font-size: 1.2rem;">${analysis.radical}</span>
        </div>
        <div class="radical-meaning">
          ${analysis.radicalData.meaning.es}
        </div>
      `;
      
      if (analysis.radicalData.category) {
        html += `<div class="radical-category">${analysis.radicalData.category}</div>`;
      }
    } else {
      html += `
        <div style="margin-bottom: 0.5rem;">
          <strong>Radical:</strong> <span class="radical-display" style="font-size: 1.2rem;">${analysis.radical}</span>
        </div>
        <div class="radical-meaning">Análisis en desarrollo</div>
      `;
    }
    
    // Etimología breve si está disponible
    if (analysis.etymology && analysis.etymology.es) {
      const shortEtymology = analysis.etymology.es.length > 80 
        ? analysis.etymology.es.substring(0, 80) + '...' 
        : analysis.etymology.es;
      html += `
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6c757d; font-style: italic;">
          💡 ${shortEtymology}
        </div>
      `;
    }
    
    html += `</div>`;
    return html;
  }

  // Función para cargar el componente de búsqueda por radicales
  async function loadRadicalSearchComponent() {
    console.log('🔍 Cargando componente de búsqueda por radicales...');
    
    const radicalContent = document.getElementById('radical-search-content');
    if (!radicalContent) return;
    
    try {
      // Cargar datos del índice de radicales
      const response = await fetch(`${baseUrl}data/chinese/radical-index.json`);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const radicalIndexData = await response.json();
      console.log(`✅ Índice de radicales cargado: ${radicalIndexData.radicals.length} radicales`);
      
      // Generar HTML del componente de búsqueda por radicales
      const radicalSearchHTML = generateRadicalSearchHTML(radicalIndexData);
      radicalContent.innerHTML = radicalSearchHTML;
      
      // Configurar funcionalidad
      setupRadicalSearchFunctionality(radicalIndexData);
      
    } catch (error) {
      console.error('❌ Error cargando búsqueda por radicales:', error);
      throw error;
    }
  }

  // Generar HTML para la búsqueda por radicales
  function generateRadicalSearchHTML(data) {
    return `
      <div class="radical-search-container" style="
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        padding: 1.5rem;
        border: 2px solid #dee2e6;
      ">
        <div class="radical-search-header" style="text-align: center; margin-bottom: 1.5rem;">
          <h3 style="color: #007bff; margin: 0 0 0.5rem 0;">🔍 Búsqueda por Radicales</h3>
          <p style="color: #6c757d; margin: 0; font-size: 0.95rem;">Encuentra caracteres organizados por sus radicales fundamentales</p>
        </div>
        
        <div class="radical-controls" style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 1.5rem;
          padding: 1rem;
          background: white;
          border-radius: 8px;
          border: 1px solid #dee2e6;
        ">
          <div>
            <label style="font-weight: 600; color: #495057; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Categoría:</label>
            <select id="radical-category-filter" style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;">
              <option value="">Todas las categorías</option>
              ${Object.keys(data.categories).map(cat => 
                `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`
              ).join('')}
            </select>
          </div>
          
          <div>
            <label style="font-weight: 600; color: #495057; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Trazos:</label>
            <select id="radical-strokes-filter" style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;">
              <option value="">Todos los trazos</option>
              ${Object.keys(data.strokesIndex).map(strokes => 
                `<option value="${strokes}">${strokes} trazo${strokes !== '1' ? 's' : ''}</option>`
              ).join('')}
            </select>
          </div>
          
          <div>
            <label style="font-weight: 600; color: #495057; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Búsqueda:</label>
            <input type="text" id="radical-text-search" placeholder="Buscar radical..." style="
              width: 100%; 
              padding: 0.5rem; 
              border: 1px solid #ced4da; 
              border-radius: 4px;
            "/>
          </div>
        </div>
        
        <div class="radical-results-header" style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          padding: 0.75rem;
          background: white;
          border-radius: 6px;
          border: 1px solid #dee2e6;
        ">
          <span id="radical-results-count" style="font-weight: 600; color: #495057;">0 radicales encontrados</span>
        </div>
        
        <div id="radical-results-container" style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 1rem;
        ">
          <!-- Los resultados se cargan aquí -->
        </div>
        
        <!-- Modal para caracteres -->
        <div id="radical-characters-modal" style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.8);
          z-index: 1000;
          align-items: center;
          justify-content: center;
          padding: 1rem;
        ">
          <div style="
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
          ">
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 1.5rem;
              border-bottom: 1px solid #dee2e6;
              background: #f8f9fa;
              border-radius: 12px 12px 0 0;
            ">
              <h4 id="radical-modal-title" style="margin: 0; color: #495057;">Caracteres con radical</h4>
              <button id="radical-modal-close" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                color: #6c757d;
                cursor: pointer;
                padding: 0.25rem;
                border-radius: 4px;
              ">&times;</button>
            </div>
            <div id="radical-modal-content" style="padding: 1.5rem;">
              <!-- Contenido se carga dinámicamente -->
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Configurar funcionalidad de la búsqueda por radicales
  function setupRadicalSearchFunctionality(data) {
    const categoryFilter = document.getElementById('radical-category-filter');
    const strokesFilter = document.getElementById('radical-strokes-filter');
    const textSearch = document.getElementById('radical-text-search');
    const resultsCount = document.getElementById('radical-results-count');
    const resultsContainer = document.getElementById('radical-results-container');
    const modal = document.getElementById('radical-characters-modal');
    const modalTitle = document.getElementById('radical-modal-title');
    const modalContent = document.getElementById('radical-modal-content');
    const modalClose = document.getElementById('radical-modal-close');
    
    let currentRadicals = [...data.radicals];
    
    // Función para filtrar radicales
    function filterRadicals() {
      let filtered = [...data.radicals];
      
      const selectedCategory = categoryFilter.value;
      if (selectedCategory) {
        filtered = filtered.filter(r => r.category === selectedCategory);
      }
      
      const selectedStrokes = strokesFilter.value;
      if (selectedStrokes) {
        filtered = filtered.filter(r => r.strokes === parseInt(selectedStrokes));
      }
      
      const searchTerm = textSearch.value.toLowerCase().trim();
      if (searchTerm) {
        filtered = filtered.filter(r => 
          r.radical.includes(searchTerm) ||
          r.meaning.es.toLowerCase().includes(searchTerm) ||
          r.meaning.en.toLowerCase().includes(searchTerm)
        );
      }
      
      currentRadicals = filtered;
      displayRadicals(filtered);
    }
    
    // Función para mostrar radicales
    function displayRadicals(radicals) {
      resultsCount.textContent = `${radicals.length} radical${radicals.length !== 1 ? 'es' : ''} encontrado${radicals.length !== 1 ? 's' : ''}`;
      
      resultsContainer.innerHTML = radicals.map(radical => {
        const hasRevolutionary = radical.characters.some(char => char.revolutionaryRelevance);
        
        return `
          <div class="radical-card" data-radical="${radical.radical}" style="
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            ${hasRevolutionary ? 'border-left: 4px solid #dc3545;' : ''}
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
          ">
            <div style="font-size: 2rem; text-align: center; margin-bottom: 0.5rem; color: #007bff;">${radical.radical}</div>
            <div style="text-align: center;">
              <div style="font-weight: 600; color: #495057; margin-bottom: 0.25rem;">${radical.meaning.es}</div>
              <div style="font-size: 0.85rem; color: #6c757d;">${radical.strokes} trazo${radical.strokes !== 1 ? 's' : ''} • Kangxi #${radical.number}</div>
              <div style="
                background: #e9ecef;
                padding: 0.25rem 0.5rem;
                border-radius: 12px;
                font-weight: 600;
                color: #495057;
                display: inline-block;
                margin-top: 0.5rem;
                font-size: 0.8rem;
              ">${radical.frequency} caracter${radical.frequency !== 1 ? 'es' : ''}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // Añadir listeners a las tarjetas
      resultsContainer.querySelectorAll('.radical-card').forEach(card => {
        card.addEventListener('mouseenter', () => {
          card.style.transform = 'translateY(-2px)';
          card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
          card.style.borderColor = '#007bff';
        });
        
        card.addEventListener('mouseleave', () => {
          card.style.transform = '';
          card.style.boxShadow = '';
          card.style.borderColor = '#dee2e6';
        });
        
        card.addEventListener('click', () => {
          const radicalChar = card.dataset.radical;
          const radicalData = radicals.find(r => r.radical === radicalChar);
          if (radicalData) {
            showCharactersModal(radicalData);
          }
        });
      });
    }
    
    // Función para mostrar modal de caracteres
    function showCharactersModal(radicalData) {
      modalTitle.textContent = `Caracteres con radical ${radicalData.radical} (${radicalData.meaning.es})`;
      
      modalContent.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <p><strong>Radical:</strong> ${radicalData.radical} (${radicalData.meaning.es})</p>
          <p><strong>Trazos:</strong> ${radicalData.strokes} • <strong>Kangxi:</strong> #${radicalData.number} • <strong>Categoría:</strong> ${radicalData.category}</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem;">
          ${radicalData.characters.map(char => `
            <div style="
              background: #f8f9fa;
              border-radius: 8px;
              padding: 1rem;
              text-align: center;
              border: 1px solid #dee2e6;
              ${char.revolutionaryRelevance ? 'border-left: 4px solid #dc3545;' : ''}
              cursor: pointer;
              transition: all 0.2s ease;
            " data-character="${char.character}">
              <div style="font-size: 2.5rem; margin-bottom: 0.5rem; color: #007bff;">${char.character}</div>
              <div style="font-weight: 600; color: #28a745; margin-bottom: 0.25rem;">${char.pinyin || 'N/A'}</div>
              <div style="font-size: 0.9rem; color: #6c757d; font-style: italic;">${char.translation || 'Sin traducción'}</div>
              ${char.revolutionaryRelevance ? '<div style="color: #dc3545; font-size: 0.8rem; margin-top: 0.25rem;">🚩 Relevancia revolucionaria</div>' : ''}
            </div>
          `).join('')}
        </div>
      `;
      
      // Añadir funcionalidad de copia al hacer clic
      modalContent.querySelectorAll('[data-character]').forEach(item => {
        item.addEventListener('mouseenter', () => {
          item.style.background = '#e9ecef';
          item.style.transform = 'scale(1.02)';
        });
        
        item.addEventListener('mouseleave', () => {
          item.style.background = '#f8f9fa';
          item.style.transform = '';
        });
        
        item.addEventListener('click', async () => {
          const character = item.dataset.character;
          try {
            await navigator.clipboard.writeText(character);
            
            // Feedback visual
            const hanzi = item.querySelector('div');
            const originalText = hanzi.textContent;
            hanzi.textContent = '✓';
            hanzi.style.color = '#28a745';
            
            setTimeout(() => {
              hanzi.textContent = originalText;
              hanzi.style.color = '#007bff';
            }, 1000);
          } catch (err) {
            console.log('No se pudo copiar al portapapeles');
          }
        });
      });
      
      modal.style.display = 'flex';
    }
    
    // Event listeners
    [categoryFilter, strokesFilter, textSearch].forEach(element => {
      element.addEventListener('change', filterRadicals);
      element.addEventListener('input', filterRadicals);
    });
    
    modalClose.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
    
    // Cargar datos iniciales
    displayRadicals(data.radicals);
  }

  window.retryLoad = init;
  
  init();
});
</script>